\AgdaHide{
\begin{code}%
\>\AgdaKeyword{import} \AgdaModule{Relation.Binary.PropositionalEquality.Core}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Prelims.Closure}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Relation.Binary} \AgdaKeyword{hiding} \AgdaSymbol{(}\AgdaFunction{\_⇒\_}\AgdaSymbol{)}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Grammar.Base}\<%
\end{code}
}

\section{Reduction}

A \emph{reduction relation} is a relation $R$ between expressions such that, whenever $M R N$, then $M$ and $N$ have the same expression kind,
and $M$ is not a variable.

\begin{code}%
\>\AgdaKeyword{module} \AgdaModule{Reduction.Base} \AgdaSymbol{(}\AgdaBound{G} \AgdaSymbol{:} \AgdaRecord{Grammar}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{R} \AgdaSymbol{:} \AgdaFunction{Grammar.Reduction} \AgdaBound{G}\AgdaSymbol{)} \AgdaKeyword{where}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Data.List}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Prelims}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Grammar} \AgdaBound{G}\<%
\end{code}
}

We define $\rightarrow_R$ to be the
congruence generated by $R$, $\twoheadrightarrow^+_R$ to be its transitive closure, $\twoheadrightarrow_R$ to be its reflexive, transitive closure, and $\simeq_R$ to be its reflexive, symmetric, transitive closure.
  We say $M$ and $N$ are \emph{$R$-convertible} iff $M \simeq_R N$.

\begin{code}%
\>\AgdaKeyword{infix} \AgdaNumber{4} \AgdaFixityOp{\_⇒\_}\<%
\\
\>\AgdaKeyword{data} \AgdaDatatype{\_⇒\_} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{K} \AgdaBound{C} \AgdaSymbol{→} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{K} \AgdaBound{C} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{redex} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{K} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{c} \AgdaSymbol{:} \AgdaFunction{Con} \AgdaSymbol{(}\AgdaInductiveConstructor{SK} \AgdaBound{AA} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaBound{F}\AgdaSymbol{\}} \AgdaSymbol{→} \<[47]%
\>[47]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaBound{R} \AgdaBound{c} \AgdaBound{E} \AgdaBound{F} \AgdaSymbol{→} \AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{E} \AgdaDatatype{⇒} \AgdaBound{F}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{app} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{K} \AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{c} \AgdaSymbol{:} \AgdaFunction{Con} \AgdaSymbol{(}\AgdaInductiveConstructor{SK} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaBound{F}\AgdaSymbol{\}} \AgdaSymbol{→} \<[43]%
\>[43]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaBound{E} \AgdaDatatype{⇒} \AgdaBound{F} \AgdaSymbol{→} \AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{E} \AgdaDatatype{⇒} \AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{F}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{appl} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{A} \AgdaBound{AA} \AgdaBound{E} \AgdaBound{E'} \AgdaBound{F}\AgdaSymbol{\}} \AgdaSymbol{→} \<[27]%
\>[27]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaBound{E} \AgdaDatatype{⇒} \AgdaBound{E'} \AgdaSymbol{→} \AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaBound{E} \AgdaBound{F} \AgdaDatatype{⇒} \AgdaBound{E'} \AgdaInductiveConstructor{∷} \AgdaBound{F}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{appr} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{A} \AgdaBound{AA} \AgdaBound{E} \AgdaBound{F} \AgdaBound{F'}\AgdaSymbol{\}} \AgdaSymbol{→} \<[27]%
\>[27]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaBound{F} \AgdaDatatype{⇒} \AgdaBound{F'} \AgdaSymbol{→} \AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaBound{E} \AgdaBound{F} \AgdaDatatype{⇒} \AgdaBound{E} \AgdaInductiveConstructor{∷} \AgdaBound{F'}\<%
\\
%
\\
\>\AgdaFunction{\_↠⁺\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{Relation} \AgdaSymbol{(}\AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{\_↠⁺\_} \AgdaSymbol{=} \AgdaDatatype{TClose} \AgdaDatatype{\_⇒\_}\<%
\\
%
\\
\>\AgdaFunction{\_↠\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{Relation} \AgdaSymbol{(}\AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{\_↠\_} \AgdaSymbol{=} \AgdaDatatype{RTClose} \AgdaDatatype{\_⇒\_}\<%
\\
%
\\
\>\AgdaFunction{RED} \AgdaSymbol{:} \AgdaDatatype{Alphabet} \AgdaSymbol{→} \AgdaSymbol{∀} \AgdaBound{C} \AgdaSymbol{→} \AgdaFunction{Kind} \AgdaBound{C} \AgdaSymbol{→} \AgdaRecord{Preorder} \AgdaSymbol{\_} \AgdaSymbol{\_} \AgdaSymbol{\_}\<%
\\
\>\AgdaFunction{RED} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K} \AgdaSymbol{=} \AgdaFunction{RTCLOSE} \AgdaSymbol{(}\AgdaDatatype{\_⇒\_} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\})}\<%
\\
%
\\
\>\AgdaKeyword{data} \AgdaDatatype{\_≃\_} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{:} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K} \AgdaSymbol{→} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \<[53]%
\>[53]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{where}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{osr-conv} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{M} \AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{M} \AgdaDatatype{⇒} \AgdaBound{N} \AgdaSymbol{→} \AgdaBound{M} \AgdaDatatype{≃} \AgdaBound{N}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{ref} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{M}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{M} \AgdaDatatype{≃} \AgdaBound{M}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{sym-conv} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{M} \AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{M} \AgdaDatatype{≃} \AgdaBound{N} \AgdaSymbol{→} \AgdaBound{N} \AgdaDatatype{≃} \AgdaBound{M}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{trans-conv} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{M} \AgdaBound{N} \AgdaBound{P}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{M} \AgdaDatatype{≃} \AgdaBound{N} \AgdaSymbol{→} \AgdaBound{N} \AgdaDatatype{≃} \AgdaBound{P} \AgdaSymbol{→} \AgdaBound{M} \AgdaDatatype{≃} \AgdaBound{P}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{redex-conv} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{c}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{F}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{R} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaBound{c} \AgdaBound{E} \AgdaBound{F} \AgdaSymbol{→} \AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{E} \AgdaDatatype{≃} \AgdaBound{F}\<%
\\
\>\AgdaFunction{redex-conv} \AgdaBound{rcEF} \AgdaSymbol{=} \AgdaInductiveConstructor{osr-conv} \AgdaSymbol{(}\AgdaInductiveConstructor{redex} \AgdaBound{rcEF}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{red⁺-red} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M} \AgdaBound{N} \AgdaSymbol{:} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{M} \AgdaFunction{↠⁺} \AgdaBound{N} \AgdaSymbol{→} \AgdaBound{M} \AgdaFunction{↠} \AgdaBound{N}\<%
\\
%
\\
\>\AgdaFunction{red-conv} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M} \AgdaBound{N} \AgdaSymbol{:} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{M} \AgdaFunction{↠} \AgdaBound{N} \AgdaSymbol{→} \AgdaBound{M} \AgdaDatatype{≃} \AgdaBound{N}\<%
\\
\>\AgdaFunction{red-conv} \AgdaSymbol{(}\AgdaInductiveConstructor{inc} \AgdaBound{M⇒N}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{osr-conv} \AgdaBound{M⇒N}\<%
\\
\>\AgdaFunction{red-conv} \AgdaInductiveConstructor{ref} \AgdaSymbol{=} \AgdaInductiveConstructor{ref}\<%
\\
\>\AgdaFunction{red-conv} \AgdaSymbol{(}\AgdaInductiveConstructor{trans} \AgdaBound{M↠N} \AgdaBound{N↠P}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{trans-conv} \AgdaSymbol{(}\AgdaFunction{red-conv} \AgdaBound{M↠N}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{red-conv} \AgdaBound{N↠P}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaFunction{convl} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaBound{E'} \AgdaSymbol{:} \AgdaFunction{Abs} \AgdaBound{V} \AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{FF} \AgdaSymbol{:} \AgdaFunction{ListAbs} \AgdaBound{V} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{→} \<[62]%
\>[62]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaBound{E} \AgdaDatatype{≃} \AgdaBound{E'} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaBound{E} \AgdaBound{FF}\AgdaSymbol{)} \AgdaDatatype{≃} \AgdaSymbol{(}\AgdaBound{E'} \AgdaInductiveConstructor{∷} \AgdaBound{FF}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{convl} \AgdaSymbol{(}\AgdaInductiveConstructor{osr-conv} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{osr-conv} \AgdaSymbol{(}\AgdaInductiveConstructor{appl} \AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{convl} \AgdaInductiveConstructor{ref} \AgdaSymbol{=} \AgdaInductiveConstructor{ref}\<%
\\
\>\AgdaFunction{convl} \AgdaSymbol{(}\AgdaInductiveConstructor{sym-conv} \AgdaBound{E≃E'}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{sym-conv} \AgdaSymbol{(}\AgdaFunction{convl} \AgdaBound{E≃E'}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{convl} \AgdaSymbol{(}\AgdaInductiveConstructor{trans-conv} \AgdaBound{E≃E'} \AgdaBound{E'≃E''}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{trans-conv} \AgdaSymbol{(}\AgdaFunction{convl} \AgdaBound{E≃E'}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{convl} \AgdaBound{E'≃E''}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaFunction{convr} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaSymbol{:} \AgdaFunction{Abs} \AgdaBound{V} \AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{FF} \AgdaBound{FF'} \AgdaSymbol{:} \AgdaFunction{ListAbs} \AgdaBound{V} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{→} \<[63]%
\>[63]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaBound{FF} \AgdaDatatype{≃} \AgdaBound{FF'} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaBound{E} \AgdaBound{FF}\AgdaSymbol{)} \AgdaDatatype{≃} \AgdaSymbol{(}\AgdaBound{E} \AgdaInductiveConstructor{∷} \AgdaBound{FF'}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{convr} \AgdaSymbol{(}\AgdaInductiveConstructor{osr-conv} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{osr-conv} \AgdaSymbol{(}\AgdaInductiveConstructor{appr} \AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{convr} \AgdaInductiveConstructor{ref} \AgdaSymbol{=} \AgdaInductiveConstructor{ref}\<%
\\
\>\AgdaFunction{convr} \AgdaSymbol{(}\AgdaInductiveConstructor{sym-conv} \AgdaBound{E≃E'}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{sym-conv} \AgdaSymbol{(}\AgdaFunction{convr} \AgdaBound{E≃E'}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{convr} \AgdaSymbol{(}\AgdaInductiveConstructor{trans-conv} \AgdaBound{E≃E'} \AgdaBound{E'≃E''}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{trans-conv} \AgdaSymbol{(}\AgdaFunction{convr} \AgdaBound{E≃E'}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{convr} \AgdaBound{E'≃E''}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaFunction{app-resp-conv} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{c} \AgdaSymbol{:} \AgdaFunction{Con} \AgdaSymbol{(}\AgdaInductiveConstructor{SK} \AgdaBound{AA} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{\{}\AgdaBound{EE} \AgdaBound{FF} \AgdaSymbol{:} \AgdaFunction{ListAbs} \AgdaBound{V} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{EE} \AgdaDatatype{≃} \AgdaBound{FF} \AgdaSymbol{→} \AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{EE} \AgdaDatatype{≃} \AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{FF}\<%
\\
\>\AgdaFunction{app-resp-conv} \AgdaSymbol{(}\AgdaInductiveConstructor{osr-conv} \AgdaBound{EE⇒FF}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{osr-conv} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{EE⇒FF}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{app-resp-conv} \AgdaInductiveConstructor{ref} \AgdaSymbol{=} \AgdaInductiveConstructor{ref}\<%
\\
\>\AgdaFunction{app-resp-conv} \AgdaSymbol{(}\AgdaInductiveConstructor{sym-conv} \AgdaBound{EE≃FF}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{sym-conv} \AgdaSymbol{(}\AgdaFunction{app-resp-conv} \AgdaBound{EE≃FF}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{app-resp-conv} \AgdaSymbol{(}\AgdaInductiveConstructor{trans-conv} \AgdaBound{EE≃FF} \AgdaBound{FF≃GG}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{trans-conv} \AgdaSymbol{(}\AgdaFunction{app-resp-conv} \AgdaBound{EE≃FF}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{app-resp-conv} \AgdaBound{FF≃GG}\AgdaSymbol{)}\<%
\end{code}
}

\begin{definition}
Let $\rhd$ be a relation between expressions such that, whenever $M \rhd N$, then $M$ and $N$ have the same kind.  Let $f$ be a function that maps expressions of kind $K$ over $U$ to expressions of kind $L$ over $V$.

We say $\rhd$ \emph{respects} $f$ iff, whenever $M \rhd N$, then $f(M) \rhd f(N)$.  Similarly for binary functions.
\end{definition}

\begin{code}%
\>\AgdaFunction{Relation'} \AgdaSymbol{:} \AgdaPrimitiveType{Set₁}\<%
\\
\>\AgdaFunction{Relation'} \AgdaSymbol{=} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{K} \AgdaBound{C} \AgdaSymbol{→} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{K} \AgdaBound{C} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
%
\\
\>\AgdaFunction{respects} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{D}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{Relation'} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaDatatype{Subexp} \AgdaBound{U} \AgdaBound{K} \AgdaBound{C} \AgdaSymbol{→} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{L} \AgdaBound{D}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaFunction{respects} \AgdaBound{R} \AgdaBound{f} \AgdaSymbol{=} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{M} \AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{R} \AgdaBound{M} \AgdaBound{N} \AgdaSymbol{→} \AgdaBound{R} \AgdaSymbol{(}\AgdaBound{f} \AgdaBound{M}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{f} \AgdaBound{N}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaFunction{respects₂} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{W}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{D}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{Relation'} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaDatatype{Subexp} \AgdaBound{U} \AgdaBound{K} \AgdaBound{C} \AgdaSymbol{→} \AgdaDatatype{Subexp} \AgdaBound{V} \AgdaBound{L} \AgdaBound{D} \AgdaSymbol{→} \AgdaDatatype{Subexp} \AgdaBound{W} \AgdaBound{M} \AgdaBound{E}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaFunction{respects₂} \AgdaBound{R} \AgdaBound{f} \AgdaSymbol{=} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{M} \AgdaBound{M'} \AgdaBound{N} \AgdaBound{N'}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{R} \AgdaBound{M} \AgdaBound{M'} \AgdaSymbol{→} \AgdaBound{R} \AgdaBound{N} \AgdaBound{N'} \AgdaSymbol{→} \AgdaBound{R} \AgdaSymbol{(}\AgdaBound{f} \AgdaBound{M} \AgdaBound{N}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{f} \AgdaBound{M'} \AgdaBound{N'}\AgdaSymbol{)}\<%
\end{code}

\begin{lemma}
If $\rightarrow_R$ respects $f$, then so do $\twoheadrightarrow^+_R$, $\twoheadrightarrow_R$ and $\simeq_R$.
\end{lemma}

\begin{code}%
\>\AgdaFunction{respects-red+} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{D}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{f}\AgdaSymbol{\}} \AgdaSymbol{→} \<[48]%
\>[48]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{respects} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{D}\AgdaSymbol{\}} \AgdaDatatype{\_⇒\_} \AgdaBound{f} \AgdaSymbol{→} \AgdaFunction{respects} \AgdaFunction{\_↠⁺\_} \AgdaBound{f}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{respects-red+} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{inc} \AgdaBound{E→F}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{inc} \AgdaSymbol{(}\AgdaBound{hyp} \AgdaBound{E→F}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{respects-red+} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{trans} \AgdaBound{E↠F} \AgdaBound{F↠G}\AgdaSymbol{)} \AgdaSymbol{=} \<[36]%
\>[36]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Prelims.Closure.trans} \AgdaSymbol{(}\AgdaFunction{respects-red+} \AgdaBound{hyp} \AgdaBound{E↠F}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{respects-red+} \AgdaBound{hyp} \AgdaBound{F↠G}\AgdaSymbol{)}\<%
\end{code}
}

\begin{code}%
\>\AgdaFunction{respects-red} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{D}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{f}\AgdaSymbol{\}} \AgdaSymbol{→} \<[47]%
\>[47]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{respects} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{D}\AgdaSymbol{\}} \AgdaDatatype{\_⇒\_} \AgdaBound{f} \AgdaSymbol{→} \AgdaFunction{respects} \AgdaFunction{\_↠\_} \AgdaBound{f}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{respects-red} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{inc} \AgdaBound{E→F}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{inc} \AgdaSymbol{(}\AgdaBound{hyp} \AgdaBound{E→F}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{respects-red} \AgdaBound{hyp} \AgdaInductiveConstructor{ref} \AgdaSymbol{=} \AgdaInductiveConstructor{ref}\<%
\\
\>\AgdaFunction{respects-red} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{trans} \AgdaBound{E↠F} \AgdaBound{F↠G}\AgdaSymbol{)} \AgdaSymbol{=} \<[35]%
\>[35]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{Prelims.Closure.trans} \AgdaSymbol{(}\AgdaFunction{respects-red} \AgdaBound{hyp} \AgdaBound{E↠F}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{respects-red} \AgdaBound{hyp} \AgdaBound{F↠G}\AgdaSymbol{)}\<%
\end{code}
}

\begin{code}%
\>\AgdaFunction{respects-conv} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{D}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{f}\AgdaSymbol{\}} \AgdaSymbol{→} \<[48]%
\>[48]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{respects} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{D}\AgdaSymbol{\}} \AgdaDatatype{\_⇒\_} \AgdaBound{f} \AgdaSymbol{→} \AgdaFunction{respects} \AgdaDatatype{\_≃\_} \AgdaBound{f}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{respects-conv} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{osr-conv} \AgdaBound{E→F}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{osr-conv} \AgdaSymbol{(}\AgdaBound{hyp} \AgdaBound{E→F}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{respects-conv} \AgdaBound{hyp} \AgdaInductiveConstructor{ref} \AgdaSymbol{=} \AgdaInductiveConstructor{ref}\<%
\\
\>\AgdaFunction{respects-conv} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{sym-conv} \AgdaBound{E≃F}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{sym-conv} \AgdaSymbol{(}\AgdaFunction{respects-conv} \AgdaBound{hyp} \AgdaBound{E≃F}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{respects-conv} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{trans-conv} \AgdaBound{E≃F} \AgdaBound{F≃G}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{trans-conv} \AgdaSymbol{(}\AgdaFunction{respects-conv} \AgdaBound{hyp} \AgdaBound{E≃F}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{respects-conv} \AgdaBound{hyp} \AgdaBound{F≃G}\AgdaSymbol{)}\<%
\end{code}
}

\begin{corollary}
The constructors in the grammar all respect $\twoheadrightarrow^+$, $\twoheadrightarrow$ and $\simeq$.
\end{corollary}

\begin{code}%
\>\AgdaFunction{app-red} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{c} \AgdaSymbol{:} \AgdaFunction{Con} \AgdaSymbol{(}\AgdaInductiveConstructor{SK} \AgdaBound{AA} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{\{}\AgdaBound{EE} \AgdaBound{FF} \AgdaSymbol{:} \AgdaFunction{ListAbs} \AgdaBound{V} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{EE} \AgdaFunction{↠} \AgdaBound{FF} \AgdaSymbol{→} \AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{EE} \AgdaFunction{↠} \AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{FF}\<%
\\
\>\AgdaFunction{app-red} \AgdaSymbol{=} \AgdaFunction{respects-red} \AgdaInductiveConstructor{app}\<%
\\
%
\\
\>\AgdaFunction{∷-redl} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaBound{E'} \AgdaSymbol{:} \AgdaFunction{Abs} \AgdaBound{V} \AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{FF} \AgdaSymbol{:} \AgdaFunction{ListAbs} \AgdaBound{V} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{E} \AgdaFunction{↠} \AgdaBound{E'} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaBound{E} \AgdaBound{FF}\AgdaSymbol{)} \AgdaFunction{↠} \AgdaSymbol{(}\AgdaBound{E'} \AgdaInductiveConstructor{∷} \AgdaBound{FF}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{∷-redl} \AgdaSymbol{=} \AgdaFunction{respects-red} \AgdaInductiveConstructor{appl}\<%
\\
%
\\
\>\AgdaFunction{∷-redr} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaSymbol{:} \AgdaFunction{Abs} \AgdaBound{V} \AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{FF} \AgdaBound{FF'} \AgdaSymbol{:} \AgdaFunction{ListAbs} \AgdaBound{V} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{FF} \AgdaFunction{↠} \AgdaBound{FF'} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaBound{E} \AgdaBound{FF}\AgdaSymbol{)} \AgdaFunction{↠} \AgdaSymbol{(}\AgdaBound{E} \AgdaInductiveConstructor{∷} \AgdaBound{FF'}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{∷-redr} \AgdaSymbol{=} \AgdaFunction{respects-red} \AgdaInductiveConstructor{appr}\<%
\\
%
\\
\>\AgdaFunction{∷-red} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaBound{E'} \AgdaSymbol{:} \AgdaFunction{Abs} \AgdaBound{V} \AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{FF} \AgdaBound{FF'} \AgdaSymbol{:} \AgdaFunction{ListAbs} \AgdaBound{V} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{E} \AgdaFunction{↠} \AgdaBound{E'} \AgdaSymbol{→} \AgdaBound{FF} \AgdaFunction{↠} \AgdaBound{FF'} \AgdaSymbol{→} \AgdaSymbol{(}\AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaBound{E} \AgdaBound{FF}\AgdaSymbol{)} \AgdaFunction{↠} \AgdaSymbol{(}\AgdaBound{E'} \AgdaInductiveConstructor{∷} \AgdaBound{FF'}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{∷-red} \AgdaBound{E↠E'} \AgdaBound{FF↠FF'} \AgdaSymbol{=} \AgdaInductiveConstructor{Prelims.Closure.trans} \AgdaSymbol{(}\AgdaFunction{∷-redl} \AgdaBound{E↠E'}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{∷-redr} \AgdaBound{FF↠FF'}\AgdaSymbol{)}\<%
\end{code}

\begin{lemma}
Let $Op$ be a family of operations.  If $R$ respects every operation in $Op$, then so does $\rightarrow_R$ (hence so do $\twoheadrightarrow_R$ and $\simeq_R$).
\end{lemma}

\begin{code}%
\>\AgdaKeyword{module} \AgdaModule{OpFamilies} \AgdaSymbol{(}\AgdaBound{Ops} \AgdaSymbol{:} \AgdaRecord{OpFamily}\AgdaSymbol{)} \AgdaKeyword{where}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{open} \AgdaModule{OpFamily} \AgdaBound{Ops}\<%
\\
%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{respects'} \AgdaSymbol{:} \AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{respects'} \AgdaSymbol{=} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K} \AgdaBound{c} \AgdaBound{M} \AgdaBound{N} \AgdaBound{σ}\AgdaSymbol{\}} \AgdaSymbol{→} \<[36]%
\>[36]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaBound{R} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaBound{c} \AgdaBound{M} \AgdaBound{N} \AgdaSymbol{→} \AgdaBound{R} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaBound{c} \AgdaSymbol{(}\AgdaFunction{ap} \AgdaBound{σ} \AgdaBound{M}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{ap} \AgdaBound{σ} \AgdaBound{N}\AgdaSymbol{)}\<%
\\
%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{aposrr} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{σ} \AgdaSymbol{:} \AgdaFunction{Op} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \<[44]%
\>[44]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{respects'} \AgdaSymbol{→} \AgdaFunction{respects} \AgdaDatatype{\_⇒\_} \AgdaSymbol{(}\AgdaFunction{ap} \AgdaSymbol{\{}\AgdaArgument{C} \AgdaSymbol{=} \AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{K} \AgdaSymbol{=} \AgdaBound{K}\AgdaSymbol{\}} \AgdaBound{σ}\AgdaSymbol{)}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{aposrr} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{redex} \AgdaBound{M▷N}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{redex} \AgdaSymbol{(}\AgdaBound{hyp} \AgdaBound{M▷N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{aposrr} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{MM→NN}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaFunction{aposrr} \AgdaBound{hyp} \AgdaBound{MM→NN}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{aposrr} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{appl} \AgdaBound{M→N}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{appl} \AgdaSymbol{(}\AgdaFunction{aposrr} \AgdaBound{hyp} \AgdaBound{M→N}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{aposrr} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{appr} \AgdaBound{NN→PP}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaInductiveConstructor{appr} \AgdaSymbol{(}\AgdaFunction{aposrr} \AgdaBound{hyp} \AgdaBound{NN→PP}\AgdaSymbol{)}\<%
\\
%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{apredr} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{σ} \AgdaSymbol{:} \AgdaFunction{Op} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaBound{F} \AgdaSymbol{:} \AgdaDatatype{Subexp} \AgdaBound{U} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{→} \<[65]%
\>[65]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{respects'} \AgdaSymbol{→} \AgdaBound{E} \AgdaFunction{↠} \AgdaBound{F} \AgdaSymbol{→} \AgdaFunction{ap} \AgdaBound{σ} \AgdaBound{E} \AgdaFunction{↠} \AgdaFunction{ap} \AgdaBound{σ} \AgdaBound{F}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{apredr} \AgdaBound{resp} \AgdaSymbol{=} \AgdaFunction{respects-red} \AgdaSymbol{(}\AgdaFunction{aposrr} \AgdaBound{resp}\AgdaSymbol{)}\<%
\end{code}
}

Let $\sigma, \tau : U \Rightarrow V$.  We say that $\sigma$ \emph{reduces} to $\tau$, $\sigma \twoheadrightarrow_R \tau$,
iff $\sigma(x) \twoheadrightarrow_R \tau(x)$ for all $x$.

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{\_↠op\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{Op} \AgdaBound{U} \AgdaBound{V} \AgdaSymbol{→} \AgdaFunction{Op} \AgdaBound{U} \AgdaBound{V} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{\_↠op\_} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaBound{σ} \AgdaBound{τ} \AgdaSymbol{=} \AgdaSymbol{∀} \AgdaBound{K} \AgdaSymbol{(}\AgdaBound{x} \AgdaSymbol{:} \AgdaDatatype{Var} \AgdaBound{U} \AgdaBound{K}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaFunction{apV} \AgdaBound{σ} \AgdaBound{x} \AgdaFunction{↠} \AgdaFunction{apV} \AgdaBound{τ} \AgdaBound{x}\<%
\end{code}

\begin{lemma}$ $
Suppose $R$ respects every operation $Op$ and $\rho \twoheadrightarrow_R \sigma$.  Then we have $(\rho , K) \twoheadrightarrow_R (\sigma , K)$, $\rho^A \twoheadrightarrow_R \sigma^A$, and
$E[\rho] \twoheadrightarrow_R E[\sigma]$ for all $K$, $A$, $E$.
\end{lemma}

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{liftOp-red} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ρ} \AgdaBound{σ} \AgdaSymbol{:} \AgdaFunction{Op} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{respects'} \AgdaSymbol{→}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaBound{ρ} \AgdaFunction{↠op} \AgdaBound{σ} \AgdaSymbol{→} \AgdaFunction{liftOp} \AgdaBound{K} \AgdaBound{ρ} \AgdaFunction{↠op} \AgdaFunction{liftOp} \AgdaBound{K} \AgdaBound{σ}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{liftOp-red} \AgdaSymbol{\_} \AgdaSymbol{\_} \AgdaSymbol{\_} \AgdaInductiveConstructor{x₀} \AgdaSymbol{=} \AgdaFunction{subst₂} \AgdaFunction{\_↠\_} \AgdaSymbol{(}\AgdaFunction{sym} \AgdaFunction{liftOp-x₀}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{sym} \AgdaFunction{liftOp-x₀}\AgdaSymbol{)} \AgdaInductiveConstructor{ref}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{liftOp-red} \AgdaBound{hyp} \AgdaBound{ρ↠σ} \AgdaBound{K} \AgdaSymbol{(}\AgdaInductiveConstructor{↑} \AgdaBound{x}\AgdaSymbol{)} \AgdaSymbol{=} \AgdaFunction{subst₂} \AgdaFunction{\_↠\_} \AgdaSymbol{(}\AgdaFunction{sym} \AgdaSymbol{(}\AgdaFunction{liftOp-↑} \AgdaBound{x}\AgdaSymbol{))} \AgdaSymbol{(}\AgdaFunction{sym} \AgdaSymbol{(}\AgdaFunction{liftOp-↑} \AgdaBound{x}\AgdaSymbol{))} \<[80]%
\>[80]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaFunction{apredr} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaBound{ρ↠σ} \AgdaBound{K} \AgdaBound{x}\AgdaSymbol{))}\<%
\end{code}
}

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{liftsOp-red} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ρ} \AgdaBound{σ} \AgdaSymbol{:} \AgdaFunction{Op} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{respects'} \AgdaSymbol{→} \<[55]%
\>[55]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaBound{ρ} \AgdaFunction{↠op} \AgdaBound{σ} \AgdaSymbol{→} \AgdaFunction{liftsOp} \AgdaBound{A} \AgdaBound{ρ} \AgdaFunction{↠op} \AgdaFunction{liftsOp} \AgdaBound{A} \AgdaBound{σ}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{liftsOp-red} \AgdaSymbol{\{}\AgdaArgument{A} \AgdaSymbol{=} \AgdaInductiveConstructor{[]}\AgdaSymbol{\}} \AgdaSymbol{\_} \AgdaBound{ρ↠σ} \AgdaSymbol{=} \AgdaBound{ρ↠σ}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{liftsOp-red} \AgdaSymbol{\{}\AgdaArgument{A} \AgdaSymbol{=} \AgdaBound{K} \AgdaInductiveConstructor{∷} \AgdaBound{A}\AgdaSymbol{\}} \AgdaBound{hyp} \AgdaBound{ρ↠σ} \AgdaSymbol{=} \AgdaFunction{liftsOp-red} \AgdaSymbol{\{}\AgdaArgument{A} \AgdaSymbol{=} \AgdaBound{A}\AgdaSymbol{\}} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaFunction{liftOp-red} \AgdaBound{hyp} \AgdaBound{ρ↠σ}\AgdaSymbol{)}\<%
\end{code}
}

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{apredl} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ρ} \AgdaBound{σ} \AgdaSymbol{:} \AgdaFunction{Op} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaSymbol{:} \AgdaDatatype{Subexp} \AgdaBound{U} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{→} \<[59]%
\>[59]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{respects'} \AgdaSymbol{→} \AgdaBound{ρ} \AgdaFunction{↠op} \AgdaBound{σ} \AgdaSymbol{→} \AgdaFunction{ap} \AgdaBound{ρ} \AgdaBound{E} \AgdaFunction{↠} \AgdaFunction{ap} \AgdaBound{σ} \AgdaBound{E}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{apredl} \AgdaSymbol{\{}\AgdaArgument{E} \AgdaSymbol{=} \AgdaInductiveConstructor{var} \AgdaBound{x}\AgdaSymbol{\}} \AgdaBound{hyp} \AgdaBound{ρ↠σ} \AgdaSymbol{=} \AgdaBound{ρ↠σ} \AgdaSymbol{\_} \AgdaBound{x}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{apredl} \AgdaSymbol{\{}\AgdaArgument{E} \AgdaSymbol{=} \AgdaInductiveConstructor{app} \AgdaSymbol{\_} \AgdaBound{E}\AgdaSymbol{\}} \AgdaBound{hyp} \AgdaBound{ρ↠σ} \AgdaSymbol{=} \AgdaFunction{respects-red} \AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaFunction{apredl} \AgdaSymbol{\{}\AgdaArgument{E} \AgdaSymbol{=} \AgdaBound{E}\AgdaSymbol{\}} \AgdaBound{hyp} \AgdaBound{ρ↠σ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{apredl} \AgdaSymbol{\{}\AgdaArgument{E} \AgdaSymbol{=} \AgdaInductiveConstructor{[]}\AgdaSymbol{\}} \AgdaSymbol{\_} \AgdaSymbol{\_} \AgdaSymbol{=} \AgdaInductiveConstructor{ref}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{apredl} \AgdaSymbol{\{}\AgdaArgument{E} \AgdaSymbol{=} \AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{\{}\AgdaArgument{A} \AgdaSymbol{=} \AgdaInductiveConstructor{SK} \AgdaBound{A} \AgdaSymbol{\_\}} \AgdaBound{E} \AgdaBound{F}\AgdaSymbol{\}} \AgdaBound{hyp} \AgdaBound{ρ↠σ} \AgdaSymbol{=} \AgdaInductiveConstructor{Prelims.Closure.trans} \AgdaSymbol{(}\AgdaFunction{respects-red} \AgdaInductiveConstructor{appl} \AgdaSymbol{(}\AgdaFunction{apredl} \AgdaSymbol{\{}\AgdaArgument{E} \AgdaSymbol{=} \AgdaBound{E}\AgdaSymbol{\}} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaFunction{liftsOp-red} \AgdaSymbol{\{}\AgdaArgument{A} \AgdaSymbol{=} \AgdaBound{A}\AgdaSymbol{\}} \AgdaBound{hyp} \AgdaBound{ρ↠σ}\AgdaSymbol{)))} \AgdaSymbol{(}\AgdaFunction{respects-red} \AgdaInductiveConstructor{appr} \AgdaSymbol{(}\AgdaFunction{apredl} \AgdaSymbol{\{}\AgdaArgument{E} \AgdaSymbol{=} \AgdaBound{F}\AgdaSymbol{\}} \AgdaBound{hyp} \AgdaBound{ρ↠σ}\AgdaSymbol{))}\<%
\end{code}
}

\begin{definition}
Let $\rhd$ be a relation between expressions such that, whenever $M \rhd N$, then $M$ and $N$ have the same kind.  Let $Op$ be a family of operators.
\begin{enumerate}
\item
We say $\rhd$ \emph{creates} $Op$s iff, whenever $M [ \sigma ] \rhd N$, then there exists $P$ such that $M \rhd P$ and $P [ \sigma ] \equiv N$.
\end{enumerate}
\end{definition}

\begin{code}%
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{record} \AgdaRecord{creation} \AgdaSymbol{(}\AgdaBound{\_▷\_} \AgdaSymbol{:} \AgdaFunction{Relation'}\AgdaSymbol{)} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \<[46]%
\>[46]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaBound{M} \AgdaSymbol{:} \AgdaDatatype{Subexp} \AgdaBound{U} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{)} \AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}} \<[27]%
\>[27]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{\{}\AgdaBound{σ} \AgdaSymbol{:} \AgdaFunction{Op} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{δ} \AgdaSymbol{:} \AgdaFunction{ap} \AgdaBound{σ} \AgdaBound{M} \AgdaBound{▷} \AgdaBound{N}\AgdaSymbol{)} \AgdaSymbol{:} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaKeyword{field}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaField{created} \AgdaSymbol{:} \AgdaDatatype{Subexp} \AgdaBound{U} \AgdaBound{C} \AgdaBound{K}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaField{red-created} \AgdaSymbol{:} \AgdaBound{M} \AgdaBound{▷} \AgdaField{created}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaField{ap-created} \AgdaSymbol{:} \AgdaFunction{ap} \AgdaBound{σ} \AgdaField{created} \AgdaDatatype{≡} \AgdaBound{N}\<%
\\
%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{creates} \AgdaSymbol{:} \AgdaFunction{Relation'} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{creates} \AgdaBound{▷} \AgdaSymbol{=} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K}\AgdaSymbol{\}} \AgdaBound{M} \AgdaSymbol{\{}\AgdaBound{N} \AgdaBound{σ}\AgdaSymbol{\}} \AgdaBound{δ} \AgdaSymbol{→} \<[38]%
\>[38]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaRecord{creation} \AgdaBound{▷} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaBound{M} \AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{σ}\AgdaSymbol{\}} \AgdaBound{δ}\<%
\\
%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{record} \AgdaRecord{creation'} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K} \AgdaBound{c}\AgdaSymbol{\}} \AgdaBound{M} \AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}} \<[37]%
\>[37]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{\{}\AgdaBound{σ} \AgdaSymbol{:} \AgdaFunction{Op} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{δ} \AgdaSymbol{:} \AgdaBound{R} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaBound{c} \AgdaSymbol{(}\AgdaFunction{ap} \AgdaBound{σ} \AgdaBound{M}\AgdaSymbol{)} \AgdaBound{N}\AgdaSymbol{)} \AgdaSymbol{:} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaKeyword{field}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaField{created} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{U} \AgdaBound{K}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaField{red-created} \AgdaSymbol{:} \AgdaBound{R} \AgdaBound{c} \AgdaBound{M} \AgdaField{created}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaField{ap-created} \AgdaSymbol{:} \AgdaFunction{ap} \AgdaBound{σ} \AgdaField{created} \AgdaDatatype{≡} \AgdaBound{N}\<%
\\
%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{creates'} \AgdaSymbol{:} \AgdaPrimitiveType{Set}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{creates'} \AgdaSymbol{=} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{C} \AgdaBound{K} \AgdaBound{c}\AgdaSymbol{\}} \AgdaBound{M} \AgdaSymbol{\{}\AgdaBound{N} \AgdaBound{σ}\AgdaSymbol{\}} \AgdaBound{δ} \AgdaSymbol{→} \<[39]%
\>[39]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaRecord{creation'} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{C}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{c}\AgdaSymbol{\}} \AgdaBound{M} \AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{σ}\AgdaSymbol{\}} \AgdaBound{δ}\<%
\\
%
\\
\>\AgdaKeyword{open} \AgdaModule{OpFamilies} \AgdaKeyword{public}\<%
\\
%
\\
\>\AgdaFunction{\_↠s\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{Sub} \AgdaBound{U} \AgdaBound{V} \AgdaSymbol{→} \AgdaFunction{Sub} \AgdaBound{U} \AgdaBound{V} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaFunction{\_↠s\_} \AgdaSymbol{=} \AgdaFunction{\_↠op\_} \AgdaFunction{SUB}\<%
\end{code}

\begin{lemma}
If $E \rightarrow_R F$ then $[x := E] \twoheadrightarrow_R [x := F]$.
\end{lemma}

\begin{code}%
\>\AgdaFunction{botsub-red} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{E} \AgdaBound{F} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{V} \AgdaSymbol{(}\AgdaInductiveConstructor{varKind} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{→} \<[58]%
\>[58]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaBound{E} \AgdaDatatype{⇒} \AgdaBound{F} \AgdaSymbol{→} \AgdaFunction{x₀:=} \AgdaBound{E} \AgdaFunction{↠s} \AgdaFunction{x₀:=} \AgdaBound{F}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{botsub-red} \AgdaBound{E⇒F} \AgdaSymbol{\_} \AgdaInductiveConstructor{x₀} \AgdaSymbol{=} \AgdaInductiveConstructor{inc} \AgdaBound{E⇒F}\<%
\\
\>\AgdaFunction{botsub-red} \AgdaSymbol{\_} \AgdaSymbol{\_} \AgdaSymbol{(}\AgdaInductiveConstructor{↑} \AgdaSymbol{\_)} \AgdaSymbol{=} \AgdaInductiveConstructor{ref}\<%
\end{code}
}

\begin{lemma}
If $R$ creates replacements, then so does $\rightarrow_R$.
\end{lemma}

\begin{code}%
\>\AgdaFunction{create-osr} \AgdaSymbol{:} \AgdaFunction{creates'} \AgdaFunction{REP} \AgdaSymbol{→} \AgdaFunction{creates} \AgdaFunction{REP} \AgdaDatatype{\_⇒\_}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaFunction{create-osr} \AgdaSymbol{\_} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaSymbol{\_)} \AgdaSymbol{()}\<%
\\
\>\AgdaFunction{create-osr} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{E}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{redex} \AgdaBound{cσE⇒F}\AgdaSymbol{)} \AgdaSymbol{=}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{let} \AgdaKeyword{open} \AgdaModule{creation'} \AgdaSymbol{(}\AgdaBound{hyp} \AgdaBound{E} \AgdaBound{cσE⇒F}\AgdaSymbol{)} \AgdaKeyword{in}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{record} \AgdaSymbol{\{} \<[11]%
\>[11]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{created} \AgdaSymbol{=} \AgdaFunction{created}\AgdaSymbol{;}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{red-created} \AgdaSymbol{=} \AgdaInductiveConstructor{redex} \AgdaFunction{red-created}\AgdaSymbol{;}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{ap-created} \AgdaSymbol{=} \AgdaFunction{ap-created} \<[28]%
\>[28]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{\}}\<%
\\
\>\AgdaFunction{create-osr} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaBound{E}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{σE⇒F}\AgdaSymbol{)} \AgdaSymbol{=} \<[42]%
\>[42]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{let} \AgdaKeyword{open} \AgdaModule{creation} \AgdaSymbol{(}\AgdaFunction{create-osr} \AgdaBound{hyp} \AgdaBound{E} \AgdaBound{σE⇒F}\AgdaSymbol{)} \AgdaKeyword{in} \<[47]%
\>[47]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{record} \AgdaSymbol{\{} \<[11]%
\>[11]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{created} \AgdaSymbol{=} \AgdaInductiveConstructor{app} \AgdaBound{c} \AgdaFunction{created}\AgdaSymbol{;} \<[29]%
\>[29]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{red-created} \AgdaSymbol{=} \AgdaInductiveConstructor{app} \AgdaFunction{red-created}\AgdaSymbol{;} \<[35]%
\>[35]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{ap-created} \AgdaSymbol{=} \AgdaFunction{cong} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaBound{c}\AgdaSymbol{)} \AgdaFunction{ap-created} \<[41]%
\>[41]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{\}}\<%
\\
\>\AgdaFunction{create-osr} \AgdaSymbol{\_} \AgdaInductiveConstructor{[]} \AgdaSymbol{()}\<%
\\
\>\AgdaFunction{create-osr} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{\_∷\_} \AgdaBound{E} \AgdaBound{F}\AgdaSymbol{)} \AgdaSymbol{\{}\AgdaArgument{σ} \AgdaSymbol{=} \AgdaBound{σ}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaInductiveConstructor{appl} \AgdaBound{σE⇒E'}\AgdaSymbol{)} \AgdaSymbol{=} \<[52]%
\>[52]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{let} \AgdaKeyword{open} \AgdaModule{creation} \AgdaSymbol{(}\AgdaFunction{create-osr} \AgdaBound{hyp} \AgdaBound{E} \AgdaBound{σE⇒E'}\AgdaSymbol{)} \AgdaKeyword{in} \<[48]%
\>[48]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{record} \AgdaSymbol{\{} \<[11]%
\>[11]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{created} \AgdaSymbol{=} \AgdaInductiveConstructor{\_∷\_} \AgdaFunction{created} \AgdaBound{F}\AgdaSymbol{;} \<[29]%
\>[29]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{red-created} \AgdaSymbol{=} \AgdaInductiveConstructor{appl} \AgdaFunction{red-created}\AgdaSymbol{;} \<[36]%
\>[36]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{ap-created} \AgdaSymbol{=} \AgdaFunction{cong} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaInductiveConstructor{\_∷\_} \AgdaBound{x} \AgdaSymbol{(}\AgdaBound{F} \AgdaFunction{〈} \AgdaBound{σ} \AgdaFunction{〉}\AgdaSymbol{))} \AgdaFunction{ap-created}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{\}}\<%
\\
\>\AgdaFunction{create-osr} \AgdaBound{hyp} \AgdaSymbol{(}\AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{\{}\AgdaArgument{A} \AgdaSymbol{=} \AgdaInductiveConstructor{SK} \AgdaBound{A} \AgdaSymbol{\_\}} \AgdaBound{E} \AgdaBound{F}\AgdaSymbol{)} \AgdaSymbol{\{}\AgdaArgument{σ} \AgdaSymbol{=} \AgdaBound{σ}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaInductiveConstructor{appr} \AgdaSymbol{\{}\AgdaArgument{F'} \AgdaSymbol{=} \AgdaBound{F'}\AgdaSymbol{\}} \AgdaBound{σF⇒F'}\AgdaSymbol{)} \AgdaSymbol{=} \<[75]%
\>[75]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{let} \AgdaKeyword{open} \AgdaModule{creation} \AgdaSymbol{\{}\AgdaArgument{Ops} \AgdaSymbol{=} \AgdaFunction{REP}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaFunction{create-osr} \AgdaBound{hyp} \AgdaBound{F} \AgdaBound{σF⇒F'}\AgdaSymbol{)} \AgdaKeyword{in} \<[60]%
\>[60]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{record} \AgdaSymbol{\{} \<[11]%
\>[11]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{created} \AgdaSymbol{=} \AgdaInductiveConstructor{\_∷\_} \AgdaBound{E} \AgdaFunction{created}\AgdaSymbol{;} \<[29]%
\>[29]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{red-created} \AgdaSymbol{=} \AgdaInductiveConstructor{appr} \AgdaFunction{red-created}\AgdaSymbol{;} \<[36]%
\>[36]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{ap-created} \AgdaSymbol{=} \AgdaFunction{cong} \AgdaSymbol{(}\AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{(}\AgdaBound{E} \AgdaFunction{〈} \AgdaFunction{OpFamily.liftsOp} \AgdaFunction{REP} \AgdaBound{A} \AgdaBound{σ} \AgdaFunction{〉}\AgdaSymbol{))} \AgdaFunction{ap-created}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{\}}\<%
\end{code}
}
