\AgdaHide{
\begin{code}%
\>\AgdaKeyword{module} \AgdaModule{PHOPL.Computable} \AgdaKeyword{where}\<%
\\
\>\AgdaKeyword{import} \AgdaModule{Relation.Binary.PreorderReasoning}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Data.Empty} \AgdaKeyword{renaming} \AgdaSymbol{(}\AgdaDatatype{⊥} \AgdaSymbol{to} \AgdaDatatype{Empty}\AgdaSymbol{)}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Data.Unit}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Data.Product} \AgdaKeyword{renaming} \AgdaSymbol{(}\AgdaInductiveConstructor{\_,\_} \AgdaSymbol{to} \AgdaInductiveConstructor{\_,p\_}\AgdaSymbol{)}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Data.List}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Prelims}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{Prelims.Closure}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{PHOPL.Grammar}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{PHOPL.PathSub}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{PHOPL.Red}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{PHOPL.Red.Confluent}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{PHOPL.SN}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{PHOPL.Rules}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{PHOPL.Meta}\<%
\\
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{PHOPL.KeyRedex}\<%
\end{code}
}

\section{Computable Expressions}

We define a model of the type theory with types as sets of terms.  For every type (proposition, equation) $T$ in context $\Gamma$, define
the set of \emph{computable} terms (proofs, paths) $E_\Gamma(T)$.

\input{PHOPL/Computable/Meaning}
\AgdaHide{
\begin{code}%
\>\AgdaKeyword{open} \AgdaKeyword{import} \AgdaModule{PHOPL.Computable.Meaning} \AgdaKeyword{public}\<%
\end{code}
}

\newcommand{\ldot}{\, . \,}
\begin{definition}[Computable Expressions]
\label{df:computable}
\begin{align*}
E_\Gamma(\chi) \eqdef \{ \delta \mid & \Gamma \vdash \delta : \chi\text{ and } \delta \in \SN \} \\
& \qquad (\chi \text{ is neutral or } \bot) \\
E_\Gamma(\phi \supset \psi) \eqdef \{ \delta \mid & \Gamma \vdash \delta : \phi \supset \psi\text{ and } \\
& \forall \Delta \supseteq \Gamma \ldot \forall \epsilon \in E_\Delta(\phi)\ldot \delta \epsilon \in E_\Gamma(\psi) \} \\
& \qquad (\phi , \psi \text{ normal forms}) \\
E_\Gamma(\phi) \eqdef \{ \delta \mid & \Gamma \vdash \delta : \phi\text{ and } \delta \in \SN \} \\
& \qquad (\phi \text{ neutral}) \\
E_\Gamma(\phi) \eqdef \{ \delta \mid & \Gamma \vdash \delta : \phi\text{ and } \delta \in E_\Gamma(\nf{\phi}) \} \\
& \qquad (\phi \text{ a weakly normalizable term}) \\
\\
E_\Gamma(\Omega) \eqdef \{ M \mid & \Gamma \vdash M : \Omega\text{ and } M \in \SN\text{ and } \\
& M \{\} \in E_\Gamma(M =_\Omega M) \} \\
E_\Gamma(A \rightarrow B) \eqdef \{ M \mid & \Gamma \vdash M : A \rightarrow B\text{ and } \\
& \forall \Delta \supseteq \Gamma\ldot \forall N \in E_\Delta(A)\ldot MN \in E_\Delta(B)\text{ and } \\
& M \{\} \in E_\Gamma(M =_{A \rightarrow B} M) \} \\
\\
E_\Gamma(\phi =_\Omega \psi) \eqdef \{ P \mid & \Gamma \vdash P : \phi =_\Omega \psi\text{ and } \\
& P^+ \in E_\Gamma(\phi \supset \psi)\text{ and } P^- \in E_\Gamma(\psi \supset \phi) \} \\
& \qquad (\phi , \psi \text{ weakly normalizable terms}) \\
\\
E_\Gamma(M =_{A \rightarrow B} M') \eqdef \{ P \mid & \Gamma \vdash P : M =_{A \rightarrow B} M'\text{ and } \\
& \forall \Delta \supseteq \Gamma\ldot \forall N, N' \in E_\Delta(A)\ldot \forall Q \in E_\Delta(N =_A N')\ldot \\
& P_{NN'}Q \in E_\Delta(MN =_B M'N') \}
\end{align*}
\end{definition}

If $\phi$ is a term that is not weakly normalizable, then $E_\Gamma(\phi)$ is undefined.  Similarly, $E_\Gamma(\phi =_\Omega \psi)$ is undefined if $\phi$ and $\psi$ are
not both weakly normalizable.

The Agda code for this definition is shown in Figure \ref{fig:compute}

\begin{figure}
\begin{code}%
\>\AgdaFunction{computeP} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Context} \AgdaBound{V} \AgdaSymbol{→} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S} \AgdaSymbol{→} \AgdaFunction{Proof} \AgdaBound{V} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaFunction{computeP} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaInductiveConstructor{nf₀} \AgdaSymbol{\_)} \AgdaBound{δ} \AgdaSymbol{=} \AgdaDatatype{SN} \AgdaBound{δ}\<%
\\
\>\AgdaFunction{computeP} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaInductiveConstructor{imp} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaBound{δ} \AgdaSymbol{=} \<[25]%
\>[25]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{W}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{Δ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{W}\AgdaSymbol{)} \AgdaSymbol{\{}\AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ε}\AgdaSymbol{\}}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaBound{ρ∶Γ⇒RΔ} \AgdaSymbol{:} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{Δ⊢ε∶φ} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{⊢} \AgdaBound{ε} \AgdaDatatype{∶} \AgdaSymbol{(}\AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ} \AgdaBound{ρ}\AgdaSymbol{)))}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaBound{computeε} \AgdaSymbol{:} \AgdaFunction{computeP} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaBound{ε}\AgdaSymbol{)} \AgdaSymbol{→} \<[42]%
\>[42]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{computeP} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{ψ} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{appP} \AgdaSymbol{(}\AgdaBound{δ} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{ε}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaFunction{computeT} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Context} \AgdaBound{V} \AgdaSymbol{→} \AgdaDatatype{Type} \AgdaSymbol{→} \AgdaFunction{Term} \AgdaBound{V} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaFunction{computeE} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Context} \AgdaBound{V} \AgdaSymbol{→} \AgdaFunction{Term} \AgdaBound{V} \AgdaSymbol{→} \AgdaDatatype{Type} \AgdaSymbol{→} \AgdaFunction{Term} \AgdaBound{V} \AgdaSymbol{→} \AgdaFunction{Path} \AgdaBound{V} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
%
\\
\>\AgdaFunction{computeT} \AgdaBound{Γ} \AgdaInductiveConstructor{Ω} \AgdaBound{M} \AgdaSymbol{=} \AgdaDatatype{SN} \AgdaBound{M}\<%
\\
\>\AgdaFunction{computeT} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{A} \AgdaInductiveConstructor{⇛} \AgdaBound{B}\AgdaSymbol{)} \AgdaBound{M} \AgdaSymbol{=} \<[23]%
\>[23]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(∀} \AgdaSymbol{\{}\AgdaBound{W}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{Δ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{W}\AgdaSymbol{)} \AgdaSymbol{\{}\AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{ρ∶Γ⇒Δ} \AgdaSymbol{:} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{Δ⊢N∶A} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{⊢} \AgdaBound{N} \AgdaDatatype{∶} \AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{computeN} \AgdaSymbol{:} \AgdaFunction{computeT} \AgdaBound{Δ} \AgdaBound{A} \AgdaBound{N}\AgdaSymbol{)} \AgdaSymbol{→}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{computeT} \AgdaBound{Δ} \AgdaBound{B} \AgdaSymbol{(}\AgdaFunction{appT} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{N}\AgdaSymbol{))} \AgdaFunction{×}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(∀} \AgdaSymbol{\{}\AgdaBound{W}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{Δ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{W}\AgdaSymbol{)} \AgdaSymbol{\{}\AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{N'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{P}\AgdaSymbol{\}} \<[42]%
\>[42]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaBound{ρ∶Γ⇒Δ} \AgdaSymbol{:} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{Δ⊢P∶N≡N'} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{⊢} \AgdaBound{P} \AgdaDatatype{∶} \AgdaBound{N} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaFunction{〉} \AgdaBound{N'}\AgdaSymbol{)} \<[58]%
\>[58]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaBound{computeN} \AgdaSymbol{:} \AgdaFunction{computeT} \AgdaBound{Δ} \AgdaBound{A} \AgdaBound{N}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{computeN'} \AgdaSymbol{:} \AgdaFunction{computeT} \AgdaBound{Δ} \AgdaBound{A} \AgdaBound{N'}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{computeP} \AgdaSymbol{:} \AgdaFunction{computeE} \AgdaBound{Δ} \AgdaBound{N} \AgdaBound{A} \AgdaBound{N'} \AgdaBound{P}\AgdaSymbol{)} \AgdaSymbol{→}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{computeE} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{appT} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{N}\AgdaSymbol{)} \AgdaBound{B} \AgdaSymbol{(}\AgdaFunction{appT} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{N'}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉} \AgdaFunction{⋆[} \AgdaBound{P} \AgdaFunction{∶} \AgdaBound{N} \AgdaFunction{∼} \AgdaBound{N'} \AgdaFunction{]}\AgdaSymbol{))}\<%
\\
%
\\
\>\AgdaFunction{computeE} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaBound{Γ} \AgdaBound{M} \AgdaInductiveConstructor{Ω} \AgdaBound{N} \AgdaBound{P} \AgdaSymbol{=} \AgdaFunction{Σ[} \AgdaBound{S} \AgdaFunction{∈} \AgdaDatatype{MeaningShape} \AgdaFunction{]} \AgdaFunction{Σ[} \AgdaBound{φ} \AgdaFunction{∈} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S} \AgdaFunction{]} \AgdaFunction{Σ[} \AgdaBound{ψ} \AgdaFunction{∈} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S} \AgdaFunction{]} \AgdaBound{M} \AgdaFunction{↠} \AgdaFunction{decode-Meaning} \AgdaBound{φ} \AgdaFunction{×} \AgdaBound{N} \AgdaFunction{↠} \AgdaFunction{decode-Meaning} \AgdaBound{ψ} \AgdaFunction{×} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaInductiveConstructor{imp} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{plus} \AgdaBound{P}\AgdaSymbol{)} \AgdaFunction{×} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{ψ} \AgdaInductiveConstructor{imp} \AgdaBound{φ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{minus} \AgdaBound{P}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{computeE} \AgdaBound{Γ} \AgdaBound{M} \AgdaSymbol{(}\AgdaBound{A} \AgdaInductiveConstructor{⇛} \AgdaBound{B}\AgdaSymbol{)} \AgdaBound{M'} \AgdaBound{P} \AgdaSymbol{=}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{W}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{Δ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{W}\AgdaSymbol{)} \AgdaSymbol{\{}\AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{N'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Q}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{ρ∶Γ⇒RΔ} \AgdaSymbol{:} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{Δ⊢Q∶N≡N'} \AgdaSymbol{:} \AgdaBound{Δ} \AgdaDatatype{⊢} \AgdaBound{Q} \AgdaDatatype{∶} \AgdaBound{N} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaFunction{〉} \AgdaBound{N'}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaBound{computeN} \AgdaSymbol{:} \AgdaFunction{computeT} \AgdaBound{Δ} \AgdaBound{A} \AgdaBound{N}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{computeN'} \AgdaSymbol{:} \AgdaFunction{computeT} \AgdaBound{Δ} \AgdaBound{A} \AgdaBound{N'}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{computeQ} \AgdaSymbol{:} \AgdaFunction{computeE} \AgdaBound{Δ} \AgdaBound{N} \AgdaBound{A} \AgdaBound{N'} \AgdaBound{Q}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaFunction{computeE} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{appT} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{N}\AgdaSymbol{)} \AgdaBound{B} \AgdaSymbol{(}\AgdaFunction{appT} \AgdaSymbol{(}\AgdaBound{M'} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \<[145]%
\>[145]\AgdaBound{N'}\AgdaSymbol{)} \<[149]%
\>[149]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaFunction{app*} \AgdaBound{N} \AgdaBound{N'} \AgdaSymbol{(}\AgdaBound{P} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{Q}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaFunction{compute} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Context} \AgdaBound{V} \AgdaSymbol{→} \AgdaFunction{Expression} \AgdaBound{V} \AgdaSymbol{(}\AgdaFunction{parent} \AgdaBound{K}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaFunction{Expression} \AgdaBound{V} \AgdaSymbol{(}\AgdaInductiveConstructor{varKind} \AgdaBound{K}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaFunction{compute} \AgdaSymbol{\{}\AgdaArgument{K} \AgdaSymbol{=} \AgdaInductiveConstructor{-Term}\AgdaSymbol{\}} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaInductiveConstructor{-ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{out}\AgdaSymbol{)} \AgdaBound{M} \AgdaSymbol{=} \AgdaFunction{computeT} \AgdaBound{Γ} \AgdaBound{A} \AgdaBound{M}\<%
\\
\>\AgdaFunction{compute} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{K} \AgdaSymbol{=} \AgdaInductiveConstructor{-Proof}\AgdaSymbol{\}} \AgdaBound{Γ} \AgdaBound{φ} \AgdaBound{δ} \AgdaSymbol{=} \AgdaFunction{Σ[} \AgdaBound{S} \AgdaFunction{∈} \AgdaDatatype{MeaningShape} \AgdaFunction{]} \AgdaFunction{Σ[} \AgdaBound{ψ} \AgdaFunction{∈} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S} \AgdaFunction{]} \AgdaBound{φ} \AgdaFunction{↠} \AgdaFunction{decode-Meaning} \AgdaBound{ψ} \AgdaFunction{×} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{ψ} \AgdaBound{δ}\<%
\\
\>\AgdaFunction{compute} \AgdaSymbol{\{}\AgdaArgument{K} \AgdaSymbol{=} \AgdaInductiveConstructor{-Path}\AgdaSymbol{\}} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaInductiveConstructor{-eq} \AgdaBound{A}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{M} \AgdaInductiveConstructor{∷} \AgdaBound{N} \AgdaInductiveConstructor{∷} \AgdaInductiveConstructor{[]}\AgdaSymbol{))} \AgdaBound{P} \AgdaSymbol{=} \AgdaFunction{computeE} \AgdaBound{Γ} \AgdaBound{M} \AgdaBound{A} \AgdaBound{N} \AgdaBound{P}\<%
\\
%
\\
\>\AgdaKeyword{record} \AgdaRecord{E} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{A} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{V} \AgdaSymbol{(}\AgdaFunction{parent} \AgdaBound{K}\AgdaSymbol{))} \AgdaSymbol{(}\AgdaBound{M} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{V} \AgdaSymbol{(}\AgdaInductiveConstructor{varKind} \AgdaBound{K}\AgdaSymbol{))} \AgdaSymbol{:} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{constructor} \AgdaInductiveConstructor{EI}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{field}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{typed} \AgdaSymbol{:} \AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaBound{M} \AgdaDatatype{∶} \AgdaBound{A}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaField{computable} \AgdaSymbol{:} \AgdaFunction{compute} \AgdaBound{Γ} \AgdaBound{A} \AgdaBound{M}\<%
\\
%
\\
\>\AgdaKeyword{data} \AgdaDatatype{allE} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{)} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{SS}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{ListMeaning} \AgdaBound{V} \AgdaBound{SS} \AgdaSymbol{→} \AgdaDatatype{List} \AgdaSymbol{(}\AgdaFunction{Proof} \AgdaBound{V}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{[]} \AgdaSymbol{:} \AgdaDatatype{allE} \AgdaBound{Γ} \AgdaInductiveConstructor{[]} \AgdaInductiveConstructor{[]}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{\_∷\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{S} \AgdaBound{SS}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{LL} \AgdaSymbol{:} \AgdaDatatype{ListMeaning} \AgdaBound{V} \AgdaBound{SS}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ} \AgdaBound{εε}\AgdaSymbol{\}} \AgdaSymbol{→} \<[68]%
\>[68]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{decode-Meaning} \AgdaBound{L}\AgdaSymbol{)} \AgdaBound{δ} \AgdaSymbol{→} \AgdaDatatype{allE} \AgdaBound{Γ} \AgdaBound{LL} \AgdaBound{εε} \AgdaSymbol{→} \AgdaDatatype{allE} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{L} \AgdaInductiveConstructor{∷} \AgdaBound{LL}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{δ} \AgdaInductiveConstructor{∷} \AgdaBound{εε}\AgdaSymbol{)}\<%
\end{code}
\caption{Agda definition of the computable expressions}
\label{fig:compute}
\end{figure}

\begin{lemma}
Every strongly normalizable term is weakly normalizable.
\end{lemma}

%TODO Agda

\begin{lemma}
If $M, N \in E_\Gamma(A)$ then $E_\Gamma(M =_A N)$ is defined.
\end{lemma}

\begin{proof}
The proof is by induction on $A$.

If $M, N \in E_\Gamma(\Omega)$ then $M$ and $N$ are strongly nomalizable, hence weakly normalizable, hence $E_\Gamma(M =_A N)$ is defined.

If $M, M' \in E_\Gamma(A \rightarrow B)$, then let $\Delta \supseteq \Gamma$ and $N, N' \in E_\Gamma(A)$.  We have that $MN, M'N' \in E_\Gamma(B)$,
and so $E_\Delta(N =_A N')$ and $E_\Delta(MN =_B M'N')$ are both defined by the induction hypothesis.
\end{proof}

%TODO Agda

Note that, if $\Gamma \subseteq \Delta$, then $E_\Gamma(T) \subseteq E_\Delta(T)$.  Note also that, if $M \in E_\Gamma(A)$,
then $M \{\} \in E_\Gamma(M =_A M)$. %TODO Agda

\AgdaHide{
\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{computeP-rep} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{S} \AgdaBound{Γ} \AgdaBound{Δ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaFunction{Rep} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{U} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[4]\AgdaIndent{23}{}\<[23]%
\>[23]\AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{L} \AgdaBound{δ} \AgdaSymbol{→} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaFunction{computeP} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{L} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{δ} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)}\<%
\\
\>\AgdaComment{\{- computeP-rep \{S = neutral\} \{L = neutral \_\} computeδ \_ = SNrep R-creates-rep computeδ\<\\
\>computeP-rep \{S = bot\} \{L = bot\} computeδ ρ∶Γ⇒RΔ = SNrep R-creates-rep computeδ\<\\
\>computeP-rep \{S = imp S T\} \{ρ = ρ\} \{L = imp φ ψ\} \{δ\} computeδ ρ∶Γ⇒RΔ Θ \{ρ'\} \{ε\} ρ'∶Δ⇒RΘ Θ⊢ε∶φ computeε = \<\\
\>  subst₂ (computeP Θ) (let open ≡-Reasoning in \<\\
\>  begin\<\\
\>    nfrep ψ (ρ' •R ρ)\<\\
\>  ≡⟨ nfrep-comp ⟩\<\\
\>    nfrep (nfrep ψ ρ) ρ'\<\\
\>  ∎) \<\\
\>  (cong (λ x → appP x ε) (rep-comp δ)) \<\\
\>  (computeδ Θ (compR-typed ρ'∶Δ⇒RΘ ρ∶Γ⇒RΔ) \<\\
\>    (change-type Θ⊢ε∶φ \<\\
\>      (cong decode-Prop \{x = nfrep (nfrep φ ρ) ρ'\} (Prelims.sym nfrep-comp))) \<\\
\>    (subst (λ x → computeP Θ x ε) \{x = nfrep (nfrep φ ρ) ρ'\} (Prelims.sym nfrep-comp) computeε)) -\}}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{compute-rep} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{Γ} \AgdaBound{Δ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaFunction{Rep} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{U} \AgdaSymbol{(}\AgdaFunction{parent} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{\{}\AgdaBound{M} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{U} \AgdaSymbol{(}\AgdaInductiveConstructor{varKind} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{→} \<[117]%
\>[117]\<%
\\
\>[0]\AgdaIndent{22}{}\<[22]%
\>[22]\AgdaRecord{E} \AgdaBound{Γ} \AgdaBound{A} \AgdaBound{M} \AgdaSymbol{→} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaFunction{compute} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaBound{A} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)}\<%
\\
\>\AgdaComment{\{- compute-rep \{V = V\} \{ρ = ρ\} \{K = -Proof\} \{φ\} \{M\} (EI typed (S ,p L ,p φ↠L ,p computeM)) ρ∶Γ⇒RΔ validΔ = S ,p nfrep L ρ ,p \<\\
\>  red-decode-rep L φ↠L ,p\<\\
\>  computeP-rep \{ρ = ρ\} \{L\} \{δ = M\} computeM ρ∶Γ⇒RΔ\<\\
\>compute-rep \{K = -Term\} \{app (-ty Ω) []\} (EI \_ SNM) \_ \_ = SNrep R-creates-rep SNM\<\\
\>compute-rep \{K = -Term\} \{app (-ty (φ ⇛ ψ)) []\} \{δ\} (EI Γ⊢δ∶φ⊃ψ (δapp ,p δeq)) ρ∶Γ⇒RΔ validΔ = (λ \{W\} Θ \{ρ'\} \{ε\} ρ'∶Δ⇒RΘ Θ⊢ε∶φ computeε → \<\\
\>  subst (computeT Θ ψ) (cong (λ x → appT x ε) (rep-comp δ)) (δapp Θ (compR-typed ρ'∶Δ⇒RΘ ρ∶Γ⇒RΔ) Θ⊢ε∶φ computeε)) ,p \<\\
\>  (λ Θ \{ρ'\} \{ε\} \{ε'\} \{P\} ρ'∶Δ⇒RΘ Θ⊢P∶ε≡ε' computeε computeε' computeP → subst\<\\
\>    (λ a → computeE Θ (appT a ε) ψ (appT a ε') (a ⋆[ P ∶ ε ∼ ε' ]))\<\\
\>    (rep-comp δ) \<\\
\>    (δeq Θ (compR-typed ρ'∶Δ⇒RΘ ρ∶Γ⇒RΔ) Θ⊢P∶ε≡ε' computeε computeε' computeP))\<\\
\>compute-rep \{V = V\} \{ρ = ρ\} \{K = -Path\} \{app (-eq Ω) (φ ∷ ψ ∷ [])\} \{P\} (EI Γ⊢P∶φ≡ψ (S ,p S' ,p L ,p L' ,p φ↠L ,p ψ↠L' ,p computeP+ ,p computeP- )) ρ∶Γ⇒RΔ validΔ = \<\\
\>  S ,p S' ,p nfrep L ρ ,p nfrep L' ρ ,p \<\\
\>  red-decode-rep L φ↠L ,p\<\\
\>  red-decode-rep L' ψ↠L' ,p \<\\
\>  (λ Θ \{ρ'\} \{ε\} ρ'∶Δ⇒RΘ Θ⊢ε∶Lρρ' computeε → subst₂ (λ a b → computeP Θ a (appP (plus b) ε)) \{nfrep L' (ρ' •R ρ)\}\<\\
\>                                              \{nfrep (nfrep L' ρ) ρ'\} \{P 〈 ρ' •R ρ 〉\} \{(P 〈 ρ 〉) 〈 ρ' 〉\} \<\\
\>  nfrep-comp (rep-comp P) (computeP+ Θ (compR-typed ρ'∶Δ⇒RΘ ρ∶Γ⇒RΔ) \<\\
\>    (change-type Θ⊢ε∶Lρρ' (cong decode-Prop \{nfrep (nfrep L ρ) ρ'\} \{nfrep L (ρ' •R ρ)\} (Prelims.sym nfrep-comp))) \<\\
\>    (subst (λ a → computeP Θ a ε) \{nfrep (nfrep L ρ) ρ'\}\<\\
\>       \{nfrep L (ρ' •R ρ)\} (Prelims.sym nfrep-comp) computeε))) ,p \<\\
\>  (λ Θ \{ρ'\} \{ε\} ρ'∶Δ⇒RΘ Θ⊢ε∶L'ρρ' computeε → subst₂ (λ a b → computeP Θ a (appP (minus b) ε)) \{nfrep L (ρ' •R ρ)\}\<\\
\>                                              \{nfrep (nfrep L ρ) ρ'\} \{P 〈 ρ' •R ρ 〉\} \{(P 〈 ρ 〉) 〈 ρ' 〉\} \<\\
\>  nfrep-comp (rep-comp P) (computeP- Θ (compR-typed ρ'∶Δ⇒RΘ ρ∶Γ⇒RΔ) \<\\
\>    (change-type Θ⊢ε∶L'ρρ' (cong decode-Prop \{nfrep (nfrep L' ρ) ρ'\} \{nfrep L' (ρ' •R ρ)\} (Prelims.sym nfrep-comp))) \<\\
\>    (subst (λ a → computeP Θ a ε) \{nfrep (nfrep L' ρ) ρ'\}\<\\
\>       \{nfrep L' (ρ' •R ρ)\} (Prelims.sym nfrep-comp) computeε)))\<\\
\>--TODO Tidy up this proof\<\\
\>compute-rep \{K = -Path\} \{app (-eq (A ⇛ B)) (F ∷ G ∷ [])\} \{P\} (EI Γ⊢P∶F≡G computeP) ρ∶Γ⇒RΔ validΔ Θ \{ρ'\} \{N\} \{N'\} \{Q\} ρ'∶Δ⇒RΘ Θ⊢Q∶N≡N' computeN computeN' computeQ = \<\\
\>  subst₃\<\\
\>    (λ a b c → computeE Θ (appT a N) B (appT b N') (app* N N' c Q)) \<\\
\>    (rep-comp F) (rep-comp G) (rep-comp P) \<\\
\>    (computeP Θ (compR-typed ρ'∶Δ⇒RΘ ρ∶Γ⇒RΔ) Θ⊢Q∶N≡N' computeN computeN' computeQ) -\}}\<%
\end{code}
}

\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{E-rep} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{Γ} \AgdaBound{Δ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaFunction{Rep} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{U} \AgdaSymbol{(}\AgdaFunction{parent} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{\{}\AgdaBound{M} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{U} \AgdaSymbol{(}\AgdaInductiveConstructor{varKind} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{→} \<[111]%
\>[111]\<%
\\
\>[0]\AgdaIndent{16}{}\<[16]%
\>[16]\AgdaRecord{E} \AgdaBound{Γ} \AgdaBound{A} \AgdaBound{M} \AgdaSymbol{→} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaBound{A} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaComment{--E-rep (EI Γ⊢M∶A computeM) ρ∶Γ⇒RΔ validΔ = EI (weakening Γ⊢M∶A validΔ ρ∶Γ⇒RΔ) (compute-rep (EI Γ⊢M∶A computeM) ρ∶Γ⇒RΔ validΔ)}\<%
\end{code}
}

\begin{lemma}
\label{lm:varcompute1}
Let $\phi$ be a weakly normalizable term.
\begin{enumerate}
\item
If $\Gamma \vald$, $φ$ is weakly normalizable and $p : \phi \in \Gamma$ then $p \in E_\Gamma(\phi)$.

\begin{code}%
\>\AgdaFunction{var-EP} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p} \AgdaSymbol{:} \AgdaDatatype{Var} \AgdaBound{V} \AgdaInductiveConstructor{-Proof}\AgdaSymbol{\}} \AgdaSymbol{→} \<[72]%
\>[72]\<%
\\
\>[0]\AgdaIndent{9}{}\<[9]%
\>[9]\AgdaDatatype{valid} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaFunction{typeof} \AgdaBound{p} \AgdaBound{Γ} \AgdaFunction{↠} \AgdaFunction{decode-Meaning} \AgdaBound{L} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{typeof} \AgdaBound{p} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{p}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{E-varP} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p} \AgdaSymbol{:} \AgdaDatatype{Var} \AgdaBound{V} \AgdaInductiveConstructor{-Proof}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaInductiveConstructor{Ω}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{typeof} \AgdaBound{p} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{typeof} \AgdaBound{p} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{p}\AgdaSymbol{)}\<%
\end{code}

\item
$E_\Gamma(\phi) \subseteq \SN$.

\begin{code}%
\>\AgdaFunction{E-SNP} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ} \AgdaSymbol{:} \AgdaFunction{Proof} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaBound{φ} \AgdaBound{δ} \AgdaSymbol{→} \AgdaDatatype{SN} \AgdaBound{δ}\<%
\end{code}
\end{enumerate}
\end{lemma}

\begin{proof}
The two parts are proved simultaneously by induction on $\nf{\phi}$.
\AgdaHide{
\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{var-computeP} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{p} \AgdaSymbol{:} \AgdaDatatype{Var} \AgdaBound{V} \AgdaInductiveConstructor{-Proof}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{L} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{p}\AgdaSymbol{)}\<%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{computeP-SN} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ} \AgdaSymbol{:} \AgdaFunction{Proof} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{L} \AgdaBound{δ} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaDatatype{SN} \AgdaBound{δ}\<%
\\
%
\\
\>\AgdaComment{--var-computeP = \{!!\}}\<%
\\
\>\AgdaComment{--computeP-SN = \{!!\}}\<%
\end{code}
}

Let $\nf{\phi} \equiv \psi_1 \supset \cdots \supset \psi_n \supset \chi$,
where $\chi$ is either $\bot$ or a neutral term.  
\begin{enumerate}
\item
Let $\Delta \supseteq \Gamma$ and $\epsilon_i \in E_\Delta(\psi_i)$ for
each $i$.
We must show that
\[ p \epsilon_1 \cdots \epsilon_n \in E_\Delta(\chi) \]
\begin{code}%
\>\AgdaFunction{computeP-wd} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{S} \AgdaBound{T} \AgdaBound{Γ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ψ} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{T}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{φ} \AgdaBound{δ} \AgdaSymbol{→} \AgdaFunction{decode-Meaning} \AgdaBound{φ} \AgdaDatatype{≡} \AgdaFunction{decode-Meaning} \AgdaBound{ψ} \AgdaSymbol{→} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{ψ} \AgdaBound{δ}\<%
\\
\>\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaInductiveConstructor{nf₀}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀} \AgdaSymbol{\_\}} \AgdaSymbol{\{}\AgdaInductiveConstructor{nf₀} \AgdaSymbol{\_\}} \AgdaBound{computeδ} \AgdaSymbol{\_} \AgdaSymbol{=} \AgdaBound{computeδ}\<%
\\
\>\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀}\AgdaSymbol{\}} \AgdaSymbol{\{\_} \AgdaInductiveConstructor{imp} \AgdaSymbol{\_\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀} \AgdaSymbol{(}\AgdaInductiveConstructor{neutral} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaSymbol{\_))\}} \AgdaSymbol{\{\_} \AgdaInductiveConstructor{imp} \AgdaSymbol{\_\}} \AgdaSymbol{\_} \AgdaSymbol{()}\<%
\\
\>\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀}\AgdaSymbol{\}} \AgdaSymbol{\{\_} \AgdaInductiveConstructor{imp} \AgdaSymbol{\_\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀} \AgdaSymbol{(}\AgdaInductiveConstructor{neutral} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaSymbol{\_} \AgdaSymbol{\_))\}} \AgdaSymbol{\{\_} \AgdaInductiveConstructor{imp} \AgdaSymbol{\_\}} \AgdaSymbol{\_} \AgdaSymbol{()}\<%
\\
\>\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀}\AgdaSymbol{\}} \AgdaSymbol{\{\_} \AgdaInductiveConstructor{imp} \AgdaSymbol{\_\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀} \AgdaInductiveConstructor{bot}\AgdaSymbol{\}} \AgdaSymbol{\{\_} \AgdaInductiveConstructor{imp} \AgdaSymbol{\_\}} \AgdaSymbol{\_} \AgdaSymbol{()}\<%
\\
\>\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaBound{S} \AgdaInductiveConstructor{imp} \AgdaBound{S₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaInductiveConstructor{nf₀}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaSymbol{\_} \AgdaInductiveConstructor{imp} \AgdaSymbol{\_\}} \AgdaSymbol{\{}\AgdaInductiveConstructor{nf₀} \AgdaSymbol{(}\AgdaInductiveConstructor{neutral} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaSymbol{\_))\}} \AgdaSymbol{\_} \AgdaSymbol{()}\<%
\\
\>\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaBound{S} \AgdaInductiveConstructor{imp} \AgdaBound{S₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaInductiveConstructor{nf₀}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaSymbol{\_} \AgdaInductiveConstructor{imp} \AgdaSymbol{\_\}} \AgdaSymbol{\{}\AgdaInductiveConstructor{nf₀} \AgdaSymbol{(}\AgdaInductiveConstructor{neutral} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaSymbol{\_} \AgdaSymbol{\_))\}\_} \AgdaSymbol{()}\<%
\\
\>\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaBound{S} \AgdaInductiveConstructor{imp} \AgdaBound{S₁}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaInductiveConstructor{nf₀}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaSymbol{\_} \AgdaInductiveConstructor{imp} \AgdaSymbol{\_\}} \AgdaSymbol{\{}\AgdaInductiveConstructor{nf₀} \AgdaInductiveConstructor{bot}\AgdaSymbol{\}} \AgdaSymbol{\_} \AgdaSymbol{()}\<%
\\
\>\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaBound{S} \AgdaInductiveConstructor{imp} \AgdaBound{S'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{T} \AgdaInductiveConstructor{imp} \AgdaBound{T'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaBound{φ} \AgdaInductiveConstructor{imp} \AgdaBound{ψ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ'} \AgdaInductiveConstructor{imp} \AgdaBound{ψ'}\AgdaSymbol{\}} \AgdaBound{computeδ} \AgdaBound{φ≡ψ} \AgdaBound{Δ} \AgdaSymbol{\{}\AgdaBound{ρ}\AgdaSymbol{\}} \AgdaBound{ρ∶Γ⇒RΔ} \AgdaBound{Δ⊢ε∶φ} \AgdaBound{computeε} \AgdaSymbol{=} \<[107]%
\>[107]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaKeyword{let} \AgdaBound{φ'ρ≡φρ} \AgdaSymbol{:} \AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ'} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaDatatype{≡} \AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ} \AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
\>[2]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaBound{φ'ρ≡φρ} \AgdaSymbol{=} \AgdaKeyword{let} \AgdaKeyword{open} \AgdaModule{≡-Reasoning} \AgdaKeyword{in}\<%
\\
\>[6]\AgdaIndent{8}{}\<[8]%
\>[8]\AgdaFunction{begin}\<%
\\
\>[8]\AgdaIndent{10}{}\<[10]%
\>[10]\AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ'} \AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{8}{}\<[8]%
\>[8]\AgdaFunction{≡⟨} \AgdaFunction{decode-Meaning-rep} \AgdaBound{φ'} \AgdaFunction{⟩}\<%
\\
\>[8]\AgdaIndent{10}{}\<[10]%
\>[10]\AgdaFunction{decode-Meaning} \AgdaBound{φ'} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\<%
\\
\>[0]\AgdaIndent{8}{}\<[8]%
\>[8]\AgdaFunction{≡⟨⟨} \AgdaFunction{rep-congl} \AgdaSymbol{(}\AgdaFunction{⊃-injl} \AgdaBound{φ≡ψ}\AgdaSymbol{)} \AgdaFunction{⟩⟩}\<%
\\
\>[8]\AgdaIndent{10}{}\<[10]%
\>[10]\AgdaFunction{decode-Meaning} \AgdaBound{φ} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\<%
\\
\>[0]\AgdaIndent{8}{}\<[8]%
\>[8]\AgdaFunction{≡⟨⟨} \AgdaFunction{decode-Meaning-rep} \AgdaBound{φ} \AgdaFunction{⟩⟩}\<%
\\
\>[8]\AgdaIndent{10}{}\<[10]%
\>[10]\AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ} \AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{8}{}\<[8]%
\>[8]\AgdaFunction{∎} \AgdaKeyword{in}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaBound{S'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{T'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaFunction{nfrep} \AgdaBound{ψ} \AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaFunction{nfrep} \AgdaBound{ψ'} \AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{computeδ} \AgdaBound{Δ} \AgdaBound{ρ∶Γ⇒RΔ} \<[76]%
\>[76]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaPostulate{change-type} \AgdaBound{Δ⊢ε∶φ} \AgdaBound{φ'ρ≡φρ}\AgdaSymbol{)}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaFunction{computeP-wd} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaBound{T}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaFunction{nfrep} \AgdaBound{φ'} \AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaFunction{nfrep} \AgdaBound{φ} \AgdaBound{ρ}\AgdaSymbol{\}} \AgdaBound{computeε} \AgdaBound{φ'ρ≡φρ}\AgdaSymbol{))} \<[76]%
\>[76]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaKeyword{let} \AgdaKeyword{open} \AgdaModule{≡-Reasoning} \AgdaKeyword{in}\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{begin}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{ψ} \AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{≡⟨} \AgdaFunction{decode-Meaning-rep} \AgdaBound{ψ} \AgdaFunction{⟩}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{decode-Meaning} \AgdaBound{ψ} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{≡⟨} \AgdaFunction{rep-congl} \AgdaSymbol{(}\AgdaFunction{⊃-injr} \AgdaBound{φ≡ψ}\AgdaSymbol{)} \AgdaFunction{⟩}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{decode-Meaning} \AgdaBound{ψ'} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{≡⟨⟨} \AgdaFunction{decode-Meaning-rep} \AgdaBound{ψ'} \AgdaFunction{⟩⟩}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{ψ'} \AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{∎}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{Enf} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{Γ} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{decode-Meaning} \AgdaBound{φ}\AgdaSymbol{)} \AgdaBound{δ} \AgdaSymbol{→} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{φ} \AgdaBound{δ}\<%
\\
%
\\
\>\AgdaFunction{EPropE} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{εε}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[4]\AgdaIndent{17}{}\<[17]%
\>[17]\AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{φ} \AgdaBound{δ} \AgdaSymbol{→} \AgdaDatatype{allE} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{domMeaning} \AgdaBound{φ}\AgdaSymbol{)} \AgdaBound{εε} \AgdaSymbol{→} \AgdaDatatype{SN} \AgdaSymbol{(}\AgdaFunction{APPP'} \AgdaBound{δ} \AgdaBound{εε}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{EPropE} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀} \AgdaSymbol{\_\}} \AgdaBound{computeδ} \AgdaInductiveConstructor{[]} \AgdaSymbol{=} \AgdaBound{computeδ}\<%
\\
\>\AgdaFunction{EPropE} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{S} \AgdaInductiveConstructor{imp} \AgdaBound{T}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{Γ} \AgdaSymbol{=} \AgdaBound{Γ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaBound{φ} \AgdaInductiveConstructor{imp} \AgdaBound{ψ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{εε} \AgdaSymbol{=} \AgdaBound{ε} \AgdaInductiveConstructor{∷} \AgdaBound{εε}\AgdaSymbol{\}} \AgdaBound{computeδ} \AgdaSymbol{(}\AgdaBound{Eε} \AgdaInductiveConstructor{∷} \AgdaBound{Eεε}\AgdaSymbol{)} \AgdaSymbol{=} \<[83]%
\>[83]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaFunction{EPropE} \AgdaSymbol{\{}\AgdaArgument{Γ} \AgdaSymbol{=} \AgdaBound{Γ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaBound{ψ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaFunction{appP} \AgdaBound{δ} \AgdaBound{ε}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{εε}\AgdaSymbol{\}} \<[41]%
\>[41]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaFunction{subst₂} \AgdaSymbol{(λ} \AgdaBound{a} \AgdaBound{b} \AgdaSymbol{→} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{a} \AgdaSymbol{(}\AgdaFunction{appP} \AgdaBound{b} \AgdaBound{ε}\AgdaSymbol{))} \AgdaFunction{nfrep-id} \AgdaFunction{rep-idRep} \<[63]%
\>[63]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaBound{computeδ} \AgdaBound{Γ} \AgdaFunction{idRep-typed} \<[28]%
\>[28]\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{(}\AgdaPostulate{change-type} \AgdaSymbol{(}\AgdaField{E.typed} \AgdaBound{Eε}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{cong} \AgdaFunction{decode-Meaning} \AgdaSymbol{\{}\AgdaBound{φ}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaFunction{Prelims.sym} \AgdaFunction{nfrep-id}\AgdaSymbol{)))}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{(}\AgdaFunction{subst} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{x} \AgdaBound{ε}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{Prelims.sym} \AgdaFunction{nfrep-id}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaPostulate{Enf} \AgdaBound{Eε}\AgdaSymbol{))))} \<[71]%
\>[71]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaBound{Eεε}\<%
\\
%
\\
\>\AgdaFunction{EPropI} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Γ} \AgdaSymbol{→}\<%
\\
\>[2]\AgdaIndent{17}{}\<[17]%
\>[17]\AgdaSymbol{(∀} \AgdaSymbol{\{}\AgdaBound{W}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Δ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{W}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{εε}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaDatatype{allE} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{listnfrep} \AgdaSymbol{(}\AgdaFunction{domMeaning} \AgdaBound{φ}\AgdaSymbol{)} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaBound{εε} \AgdaSymbol{→} \AgdaDatatype{SN} \AgdaSymbol{(}\AgdaFunction{APPP'} \AgdaSymbol{(}\AgdaBound{δ} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{εε}\AgdaSymbol{))} \AgdaSymbol{→}\<%
\\
\>[2]\AgdaIndent{17}{}\<[17]%
\>[17]\AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{φ} \AgdaBound{δ}\<%
\\
\>\AgdaFunction{EPropI} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaInductiveConstructor{nf₀} \AgdaBound{N}\AgdaSymbol{\}} \AgdaBound{validΓ} \AgdaBound{hyp} \AgdaSymbol{=} \AgdaFunction{subst} \AgdaDatatype{SN} \AgdaFunction{rep-idRep} \AgdaSymbol{(}\AgdaBound{hyp} \AgdaFunction{idRep-typed} \AgdaBound{validΓ} \AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
\>\AgdaFunction{EPropI} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaBound{φ} \AgdaInductiveConstructor{imp} \AgdaBound{ψ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ}\AgdaSymbol{\}} \AgdaBound{validΓ} \AgdaBound{hyp} \AgdaBound{Δ} \AgdaSymbol{\{}\AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ε}\AgdaSymbol{\}} \AgdaBound{ρ∶Γ⇒RΔ} \AgdaBound{Δ⊢ε∶φ} \AgdaBound{computeε} \AgdaSymbol{=} \AgdaFunction{EPropI} \AgdaSymbol{\{}\AgdaArgument{φ} \AgdaSymbol{=} \AgdaFunction{nfrep} \AgdaBound{ψ} \AgdaBound{ρ}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaFunction{context-validity} \AgdaBound{Δ⊢ε∶φ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(λ} \AgdaSymbol{\{}\AgdaBound{W'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Θ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{σ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{εε}\AgdaSymbol{\}} \AgdaBound{σ∶Δ⇒RΘ} \AgdaBound{validΘ} \AgdaBound{Eεε} \AgdaSymbol{→} \AgdaFunction{subst} \AgdaSymbol{(λ} \AgdaBound{a} \AgdaSymbol{→} \AgdaDatatype{SN} \AgdaSymbol{(}\AgdaFunction{APPP'} \AgdaSymbol{(}\AgdaFunction{appP} \AgdaBound{a} \AgdaSymbol{(}\AgdaBound{ε} \AgdaFunction{〈} \AgdaBound{σ} \AgdaFunction{〉}\AgdaSymbol{))} \AgdaBound{εε}\AgdaSymbol{))} \<[90]%
\>[90]\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaSymbol{(}\AgdaFunction{rep-comp} \AgdaBound{δ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{hyp} \AgdaSymbol{\{}\AgdaArgument{εε} \AgdaSymbol{=} \AgdaBound{ε} \AgdaFunction{〈} \AgdaBound{σ} \AgdaFunction{〉} \AgdaInductiveConstructor{∷} \AgdaBound{εε}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaFunction{•R-typed} \AgdaBound{ρ∶Γ⇒RΔ} \AgdaBound{σ∶Δ⇒RΘ}\AgdaSymbol{)} \AgdaBound{validΘ} \<[72]%
\>[72]\<%
\\
\>[2]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaSymbol{(}\AgdaFunction{subst} \AgdaSymbol{(λ} \AgdaBound{a} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Θ} \AgdaBound{a} \AgdaSymbol{(}\AgdaBound{ε} \AgdaFunction{〈} \AgdaBound{σ} \AgdaFunction{〉}\AgdaSymbol{))} \AgdaSymbol{(}\AgdaKeyword{let} \AgdaKeyword{open} \AgdaModule{≡-Reasoning} \AgdaKeyword{in} \<[60]%
\>[60]\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{begin}\<%
\\
\>[6]\AgdaIndent{8}{}\<[8]%
\>[8]\AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaFunction{〈} \AgdaBound{σ} \AgdaFunction{〉}\<%
\\
\>[0]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{≡⟨⟨} \AgdaFunction{decode-Meaning-rep} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaFunction{⟩⟩}\<%
\\
\>[6]\AgdaIndent{8}{}\<[8]%
\>[8]\AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaBound{σ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{≡⟨⟨} \AgdaFunction{cong} \AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep-comp} \AgdaSymbol{\{}\AgdaArgument{M} \AgdaSymbol{=} \AgdaBound{φ}\AgdaSymbol{\})} \AgdaFunction{⟩⟩}\<%
\\
\>[6]\AgdaIndent{8}{}\<[8]%
\>[8]\AgdaFunction{decode-Meaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{φ} \AgdaSymbol{(}\AgdaBound{σ} \AgdaFunction{•R} \AgdaBound{ρ} \AgdaSymbol{))}\<%
\\
\>[0]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{∎}\AgdaSymbol{)} \<[9]%
\>[9]\<%
\\
\>[0]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaSymbol{(}\AgdaPostulate{E-rep} \AgdaSymbol{(}\AgdaInductiveConstructor{EI} \AgdaBound{Δ⊢ε∶φ} \AgdaSymbol{(\_} \AgdaInductiveConstructor{,p} \AgdaFunction{nfrep} \AgdaBound{φ} \AgdaBound{ρ} \AgdaInductiveConstructor{,p} \AgdaInductiveConstructor{ref} \AgdaInductiveConstructor{,p} \AgdaBound{computeε}\AgdaSymbol{))} \AgdaBound{σ∶Δ⇒RΘ} \AgdaBound{validΘ}\AgdaSymbol{)} \<[75]%
\>[75]\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaInductiveConstructor{∷} \AgdaFunction{subst} \AgdaSymbol{(λ} \AgdaBound{x} \AgdaSymbol{→} \AgdaDatatype{allE} \AgdaBound{Θ} \AgdaBound{x} \AgdaBound{εε}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaKeyword{let} \AgdaKeyword{open} \AgdaModule{≡-Reasoning} \AgdaKeyword{in} \<[57]%
\>[57]\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{begin}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{listnfrep} \AgdaSymbol{(}\AgdaFunction{domMeaning} \AgdaSymbol{(}\AgdaFunction{nfrep} \AgdaBound{ψ} \AgdaBound{ρ}\AgdaSymbol{))} \AgdaBound{σ}\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{≡⟨} \AgdaFunction{cong} \AgdaSymbol{(λ} \AgdaBound{a} \AgdaSymbol{→} \AgdaFunction{listnfrep} \AgdaBound{a} \AgdaBound{σ}\AgdaSymbol{)} \AgdaFunction{domMeaning-rep} \AgdaFunction{⟩}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{listnfrep} \AgdaSymbol{(}\AgdaFunction{listnfrep} \AgdaSymbol{(}\AgdaFunction{domMeaning} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaBound{σ}\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{≡⟨⟨} \AgdaFunction{listnfrep-comp} \AgdaFunction{⟩⟩}\<%
\\
\>[4]\AgdaIndent{6}{}\<[6]%
\>[6]\AgdaFunction{listnfrep} \AgdaSymbol{(}\AgdaFunction{domMeaning} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{σ} \AgdaFunction{•R} \AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaFunction{∎}\AgdaSymbol{)} \<[7]%
\>[7]\<%
\\
\>[0]\AgdaIndent{4}{}\<[4]%
\>[4]\AgdaBound{Eεε}\AgdaSymbol{)))}\<%
\\
\>\AgdaComment{-- TODO Swap arguments in •R-typed}\<%
\end{code}
It is easy to see that $p \vec{\epsilon}$ is well-typed, so it remains to show that $p \vec{\epsilon} \in \SN$.
This holds because each $\epsilon_i$ is strongly normalizing by the induction hypothesis (2).
\item
Let $\delta \in E_\Gamma(\phi)$.  Consider the context $\Delta \equiv \Gamma, p_1 : \psi_1, \ldots, p_n : \psi_n$.
By the induction hypothesis (1), we have that $p_i \in E_\Delta(\psi_i)$, hence
$\delta p_1 \cdots p_n \in E_\Gamma(\chi)$, and so $\delta p_1 \cdots p_n \in \SN$.
It follows that $\delta \in \SN$.
\end{enumerate}
\AgdaHide{
\begin{code}%
\>\AgdaFunction{var-EP} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{p} \AgdaSymbol{=} \AgdaBound{p}\AgdaSymbol{\}} \AgdaBound{validΓ} \AgdaBound{φ↠L} \AgdaSymbol{=} \AgdaInductiveConstructor{EI} \AgdaSymbol{(}\AgdaInductiveConstructor{varR} \AgdaBound{p} \AgdaBound{validΓ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{S} \AgdaInductiveConstructor{,p} \AgdaBound{L} \AgdaInductiveConstructor{,p} \AgdaBound{φ↠L} \AgdaInductiveConstructor{,p} \AgdaPostulate{var-computeP} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaBound{S}\AgdaSymbol{\})}\<%
\\
%
\\
\>\AgdaFunction{E-SNP} \AgdaSymbol{(}\AgdaInductiveConstructor{EI} \AgdaBound{Γ⊢δ∶φ} \AgdaSymbol{(}\AgdaBound{S} \AgdaInductiveConstructor{,p} \AgdaBound{L} \AgdaInductiveConstructor{,p} \AgdaSymbol{\_} \AgdaInductiveConstructor{,p} \AgdaBound{computeδ}\AgdaSymbol{))} \AgdaSymbol{=} \AgdaPostulate{computeP-SN} \AgdaSymbol{\{}\AgdaArgument{S} \AgdaSymbol{=} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaArgument{L} \AgdaSymbol{=} \AgdaBound{L}\AgdaSymbol{\}} \AgdaBound{computeδ} \AgdaSymbol{(}\AgdaFunction{context-validity} \AgdaBound{Γ⊢δ∶φ}\AgdaSymbol{)}\<%
\end{code}
}
\end{proof}

\begin{lemma}
\label{lm:varcompute2}
Let $A$ be a type.
\begin{enumerate}
\item
If $\Gamma \vald$ and $x : A \in \Gamma$ then $x \in E_\Gamma(A)$.

\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{E-varT} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{x} \AgdaSymbol{:} \AgdaDatatype{Var} \AgdaBound{V} \AgdaInductiveConstructor{-Term}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{typeof} \AgdaBound{x} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{x}\AgdaSymbol{)}\<%
\end{code}
\item
$E_\Gamma(A) \subseteq \SN$.

\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{E-SNT} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{M} \AgdaSymbol{→} \AgdaDatatype{SN} \AgdaBound{M}\<%
\end{code}
\item
If $\Gamma \vald$ and $e : M =_A N \in \Gamma$ and $M, N \in E_\Gamma(A)$ then $e \in E_\Gamma(M =_A N)$.

\begin{code}%
\>\AgdaFunction{E-eq} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Context} \AgdaBound{V} \AgdaSymbol{→} \AgdaFunction{Equation} \AgdaBound{V} \AgdaSymbol{→} \AgdaPrimitiveType{Set}\<%
\\
\>\AgdaFunction{E-eq} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaInductiveConstructor{app} \AgdaSymbol{(}\AgdaInductiveConstructor{-eq} \AgdaBound{A}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{M} \AgdaInductiveConstructor{∷} \AgdaBound{N} \AgdaInductiveConstructor{∷} \AgdaInductiveConstructor{[]}\AgdaSymbol{))} \AgdaSymbol{=} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{M} \AgdaFunction{×} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{N}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{E-varE} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{x} \AgdaSymbol{:} \AgdaDatatype{Var} \AgdaBound{V} \AgdaInductiveConstructor{-Path}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaFunction{E-eq} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{typeof} \AgdaBound{x} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{typeof} \AgdaBound{x} \AgdaBound{Γ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaInductiveConstructor{var} \AgdaBound{x}\AgdaSymbol{)}\<%
\end{code}
\item
For all $M, N \in E_\Gamma(A)$, we have $E_\Gamma(M =_A N) \subseteq \SN$.

\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{E-SNE} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Eq} \AgdaSymbol{:} \AgdaFunction{Equation} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{P} \AgdaSymbol{:} \AgdaFunction{Path} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaBound{Eq} \AgdaBound{P} \AgdaSymbol{→} \AgdaDatatype{SN} \AgdaBound{P}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{E-SN} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{K}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{V} \AgdaSymbol{(}\AgdaFunction{parent} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{\{}\AgdaBound{M} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaBound{V} \AgdaSymbol{(}\AgdaInductiveConstructor{varKind} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaBound{A} \AgdaBound{M} \AgdaSymbol{→} \AgdaDatatype{SN} \AgdaBound{M}\<%
\end{code}
\end{enumerate}
\end{lemma}

\begin{proof}
The four parts are proved simultaneously by induction on $A$.  Let $A \equiv A_1 \rightarrow \cdots \rightarrow A_n \rightarrow \Omega$,
and suppose the lemma holds for each $A_i$.
\begin{enumerate}
\item
Let $\Delta \supseteq \Gamma$.  We must prove the following:
\begin{enumerate}
\item
Given $M_i \in E_\Delta(A_i)$ for $1 \leq i \leq n$, we must show that $x M_1 \cdots M_n \in E_\Delta(\Omega)$.  We have that
each $M_i \in \SN$ by the induction hypothesis, hence $x \vec{M} \in \SN$.

Now, let $\delta \in E_\Delta(x \vec{M})$.  We must show that $(x \vec{M}) \{\} ^+ \delta \in E_\Delta(x \vec{M})$,
i.e. $(\reff{x}_{M_1 M_1} M_1 \{\}_{M_2 M_2} \cdots_{M_n M_n} M_n\{\})^+ \delta \in E_\Delta(x \vec{M})$.
Well-typedness is easy, and strong normalization follows from the fact that each $M_i$ and $M_i \{\}$ is strongly
normalizing by the induction hypothesis (2) and (4).  (Note that $\reff{x}$ cannot be part of a redex, as it is not closed.)
\item
Given $M_i \in E_\Delta(A_i)$ for $1 \leq i \leq k$, and $N_j, N_j' \in E_\Delta(A_j)$ and $P_j \in E_\Delta(M_j =_{A_j} N_j)$ for
$k < j \leq n$, we must show that \\
$(x M_1 \cdots M_k)\{\}_{N_{k+1}N_{k+1}'} (P_{k+1})_{N_{k+2}N_{k+2}'} \cdots_{N_n N_n'} P_n \in E_\Delta(x \vec{M} \vec{N} =_\Omega x \vec{M} \vec{N'})$,
i.e.
\begin{align*}
(\reff{x}_{M_1 M_1} M_1\{\} \cdots_{M_k M_k} M_k\{\}_{M_{k+1} N_{k+1}} P_{k+1} \cdots_{M_n N_n} P_n)^+ \\
\in E_\Delta(x \vec{M} \vec{N} \supset x \vec{M} \vec{N'}) \\
(\reff{x}_{M_1 M_1} M_1\{\} \cdots_{M_k M_k} M_k\{\}_{M_{k+1} N_{k+1}} P_{k+1} \cdots_{M_n N_n} P_n)^- \\
\in E_\Delta(x \vec{M} \vec{N'} \supset x \vec{M} \vec{N})
\end{align*}
The proof is similar to the previous part.
\end{enumerate}
\item
Let $M \in E_\Gamma(A)$.  Then using the induction hypothesis $M x_1 \cdots x_n \in E_{\Gamma, x_1 : A_1, \ldots, x_n : A_n}(\Omega) \subseteq \SN$,
hence $M \in \SN$.
\item
Let $\Delta \supseteq \Gamma$.  Let $L_i, L_i' \in E_\Delta(A_i)$ and
$P_i \in E_\Delta(L_i =_{A_i} L_i')$ for $i = 1, \ldots, n$.  We must show that
$e \vec{P} \equiv e_{L_1 L_1'} P_1 \cdots_{L_n L_n'} P_n \in E_\Delta(M L_1 \cdots L_n =_{\Omega} N L_1' \cdots L_n')$, i.e. that
\begin{align*}
(e \vec{P})^+ \in E_\Delta(M \vec{L} \supset N \vec{L'}) \\
(e \vec{P})^- \in E_\Delta(N \vec{L'} \supset M \vec{L})
\end{align*}
We prove the first of these; the second is similar.

Let $\Theta \supseteq \Delta$.  Let $\delta \in E_\Theta(M \vec{L})$.
Let $\nf{N \vec{L'}} \equiv \phi_1 \supset \cdots \supset \phi_m \supset \chi$,
where $\chi$ is $\bot$ or neutral.  (We know $\nf{N \vec{L'}}$ exists because
$N \vec{L'} \in E_\Delta(\Omega)$.)  Let $\epsilon_j \in E_\Theta(\phi_j)$ for
$j = 1, \ldots, m$.  Then we must show that
\[ (e \vec{P})^+ \delta \epsilon_1 \cdots \epsilon_m \in E_\Theta(\chi) \]
Well-typedness is easy to show, so it remains to show $(e \vec{P})^+ \delta \vec{\epsilon} \in \SN$.  This holds as each $P_i$, $\delta$ and $\epsilon_j$ is
strongly normalizing.
\item
Let $P \in E_\Gamma(M =_A N)$.  Let $\Delta$ be the context
\[ \Gamma, x_1 : A_1, y_1 : A_1, e_1 : x_1 =_{A_1} y_1, \ldots, x_n : A_n, y_n : A_n, e_n : x_n =_{A_n} y_n \enspace \]
Then using the induction hypothesis $P \vec{e} \equiv P_{x_1 y_1} e_1 \cdots_{x_n y_n} e_n \in E_\Gamma(M \vec{x} =_\Omega N \vec{y})$ and so
$(P \vec{e})^+ \in E_\Gamma(M \vec{x} \supset N \vec{y}) \subseteq \SN$, hence $P \in \SN$.
\end{enumerate}
\end{proof}

\begin{proposition}
\begin{enumerate}
\item
If $\delta \in E_\Gamma(\phi)$, $\phi \simeq \psi$ and $\Gamma \vdash \psi : \Omega$, then $\delta \in E_\Gamma(\psi)$.
\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{conv-computeP} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{L} \AgdaBound{M} \AgdaSymbol{:} \AgdaDatatype{Meaning} \AgdaBound{V} \AgdaBound{S}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[4]\AgdaIndent{24}{}\<[24]%
\>[24]\AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{L} \AgdaBound{δ} \AgdaSymbol{→} \AgdaFunction{decode-Meaning} \AgdaBound{L} \AgdaFunction{≃} \AgdaFunction{decode-Meaning} \AgdaBound{M} \AgdaSymbol{→}\<%
\\
\>[4]\AgdaIndent{24}{}\<[24]%
\>[24]\AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaFunction{decode-Meaning} \AgdaBound{M} \AgdaDatatype{∶} \AgdaFunction{ty} \AgdaInductiveConstructor{Ω} \AgdaSymbol{→} \AgdaFunction{computeP} \AgdaBound{Γ} \AgdaBound{M} \AgdaBound{δ}\<%
\end{code}
\item
If $P \in E_\Gamma(M =_A N)$, $M \simeq M'$, $N \simeq N'$ and $\Gamma \vdash M : A$ and $\Gamma \vdash N : A$, then $P \in E_\Gamma(M' =_A N')$.
\AgdaHide{
\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{conv-computeE} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{N'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{P}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[4]\AgdaIndent{24}{}\<[24]%
\>[24]\AgdaFunction{computeE} \AgdaBound{Γ} \AgdaBound{M} \AgdaBound{A} \AgdaBound{N} \AgdaBound{P} \AgdaSymbol{→} \<[45]%
\>[45]\<%
\\
\>[4]\AgdaIndent{24}{}\<[24]%
\>[24]\AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaBound{M} \AgdaDatatype{∶} \AgdaFunction{ty} \AgdaBound{A} \AgdaSymbol{→} \AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaBound{N} \AgdaDatatype{∶} \AgdaFunction{ty} \AgdaBound{A} \AgdaSymbol{→} \AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaBound{M'} \AgdaDatatype{∶} \AgdaFunction{ty} \AgdaBound{A} \AgdaSymbol{→} \AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaBound{N'} \AgdaDatatype{∶} \AgdaFunction{ty} \AgdaBound{A} \AgdaSymbol{→} \AgdaBound{M} \AgdaFunction{≃} \AgdaBound{M'} \AgdaSymbol{→} \AgdaBound{N} \AgdaFunction{≃} \AgdaBound{N'} \AgdaSymbol{→}\<%
\\
\>[4]\AgdaIndent{24}{}\<[24]%
\>[24]\AgdaFunction{computeE} \AgdaBound{Γ} \AgdaBound{M'} \AgdaBound{A} \AgdaBound{N'} \AgdaBound{P}\<%
\\
\>\AgdaComment{\{- conv-computeE \{Γ = Γ\} \{M = M\} \{M' = M'\} \{A = Ω\} \{N' = N'\} \{P\} (S ,p T ,p φ ,p ψ ,p M↠φ ,p N↠ψ ,p computeP+ ,p computeP-) \<\\
\>  Γ⊢M∶A Γ⊢N∶A Γ⊢M'∶A Γ⊢N'∶A M≃M' N≃N' = \<\\
\>    let (Q ,p φ↠Q ,p M'↠Q) = Church-Rosser (RSTClose.trans (RSTClose.sym (red-conv M↠φ)) M≃M') in\<\\
\>    let (φ' ,p φ'≡Q) = leaves-red \{L = φ\} φ↠Q in\<\\
\>    let (R ,p ψ↠R ,p N'↠R) = Church-Rosser (RSTClose.trans (RSTClose.sym (red-conv N↠ψ)) N≃N') in\<\\
\>    let (ψ' ,p ψ'≡R) = leaves-red \{L = ψ\} ψ↠R in\<\\
\>    S ,p T ,p φ' ,p ψ' ,p subst (\_↠\_ M') (Prelims.sym φ'≡Q) M'↠Q ,p \<\\
\>    subst (\_↠\_ N') (Prelims.sym ψ'≡R) N'↠R ,p \<\\
\>    (λ Δ \{ρ\} \{ε\} ρ∶Γ⇒RΔ Δ⊢ε∶φ'ρ computeε → \<\\
\>      let step1 : Δ ⊢ decode-Prop (nfrep φ ρ) ∶ ty Ω\<\\
\>          step1 = subst (λ x → Δ ⊢ x ∶ ty Ω) \<\\
\>            (Prelims.sym (decode-rep φ)) \<\\
\>            (weakening \<\\
\>              (subject-reduction \<\\
\>                Γ⊢M∶A M↠φ) (context-validity Δ⊢ε∶φ'ρ) ρ∶Γ⇒RΔ) in\<\\
\>      let step1a : decode-Prop (nfrep φ' ρ) ≃ decode-Prop (nfrep φ ρ)\<\\
\>          step1a = subst₂ \_≃\_ (Prelims.sym (Prelims.trans (decode-rep φ') (rep-congl φ'≡Q))) (Prelims.sym (decode-rep φ)) (conv-rep \{M = Q\} \{N = decode-Prop φ\} \<\\
\>            (RSTClose.sym (red-conv φ↠Q))) in \<\\
\>      let step2 : Δ ⊢ ε ∶ decode-Prop (nfrep φ ρ)\<\\
\>          step2 = convR Δ⊢ε∶φ'ρ step1 step1a in\<\\
\>      let step3 : computeP Δ (nfrep φ ρ) ε\<\\
\>          step3 = conv-computeP \{L = nfrep φ' ρ\} \{M = nfrep φ ρ\} computeε step1a step1 in\<\\
\>      let step4 : computeP Δ (nfrep ψ ρ) (appP (plus P 〈 ρ 〉) ε)\<\\
\>          step4 = computeP+ Δ ρ∶Γ⇒RΔ step2 step3 in \<\\
\>      let step5 : decode-Prop (nfrep ψ' ρ) ≃ decode-Prop (nfrep ψ ρ)\<\\
\>          step5 = subst₂ \_≃\_ (Prelims.sym (Prelims.trans (decode-rep ψ') (rep-congl ψ'≡R))) (Prelims.sym (decode-rep ψ)) (conv-rep \{M = R\} \{N = decode-Prop ψ\} \<\\
\>            (RSTClose.sym (red-conv ψ↠R))) in\<\\
\>      let step6 : Δ ⊢ decode-Prop (nfrep ψ' ρ) ∶ ty Ω\<\\
\>          step6 = subst (λ x → Δ ⊢ x ∶ ty Ω) (Prelims.sym (decode-rep ψ')) \<\\
\>                (weakening \<\\
\>                  (subst (λ x → Γ ⊢ x ∶ ty Ω) (Prelims.sym ψ'≡R) \<\\
\>                  (subject-reduction Γ⊢N'∶A N'↠R)) \<\\
\>                (context-validity Δ⊢ε∶φ'ρ) \<\\
\>                ρ∶Γ⇒RΔ) in\<\\
\>      conv-computeP \{L = nfrep ψ ρ\} \{M = nfrep ψ' ρ\} step4 (RSTClose.sym step5) step6) ,p \<\\
\>    (    (λ Δ \{ρ\} \{ε\} ρ∶Γ⇒RΔ Δ⊢ε∶ψ'ρ computeε → \<\\
\>      let step1 : Δ ⊢ decode-Prop (nfrep ψ ρ) ∶ ty Ω\<\\
\>          step1 = subst (λ x → Δ ⊢ x ∶ ty Ω) \<\\
\>            (Prelims.sym (decode-rep ψ)) \<\\
\>            (weakening \<\\
\>              (subject-reduction \<\\
\>                Γ⊢N∶A N↠ψ) (context-validity Δ⊢ε∶ψ'ρ) ρ∶Γ⇒RΔ) in\<\\
\>      let step1a : decode-Prop (nfrep ψ' ρ) ≃ decode-Prop (nfrep ψ ρ)\<\\
\>          step1a = subst₂ \_≃\_ (Prelims.sym (Prelims.trans (decode-rep ψ') (rep-congl ψ'≡R))) (Prelims.sym (decode-rep ψ)) (conv-rep \{M = R\} \{N = decode-Prop ψ\} \<\\
\>            (RSTClose.sym (red-conv ψ↠R))) in \<\\
\>      let step2 : Δ ⊢ ε ∶ decode-Prop (nfrep ψ ρ)\<\\
\>          step2 = convR Δ⊢ε∶ψ'ρ step1 step1a in\<\\
\>      let step3 : computeP Δ (nfrep ψ ρ) ε\<\\
\>          step3 = conv-computeP \{L = nfrep ψ' ρ\} \{M = nfrep ψ ρ\} computeε step1a step1 in\<\\
\>      let step4 : computeP Δ (nfrep φ ρ) (appP (minus P 〈 ρ 〉) ε)\<\\
\>          step4 = computeP- Δ ρ∶Γ⇒RΔ step2 step3 in \<\\
\>      let step5 : decode-Prop (nfrep φ' ρ) ≃ decode-Prop (nfrep φ ρ)\<\\
\>          step5 = subst₂ \_≃\_ (Prelims.sym (Prelims.trans (decode-rep φ') (rep-congl φ'≡Q))) (Prelims.sym (decode-rep φ)) (conv-rep \{M = Q\} \{N = decode-Prop φ\} \<\\
\>            (RSTClose.sym (red-conv φ↠Q))) in\<\\
\>      let step6 : Δ ⊢ decode-Prop (nfrep φ' ρ) ∶ ty Ω\<\\
\>          step6 = subst (λ x → Δ ⊢ x ∶ ty Ω) (Prelims.sym (decode-rep φ')) \<\\
\>                (weakening \<\\
\>                  (subst (λ x → Γ ⊢ x ∶ ty Ω) (Prelims.sym φ'≡Q) \<\\
\>                  (subject-reduction Γ⊢M'∶A M'↠Q)) \<\\
\>                (context-validity Δ⊢ε∶ψ'ρ) \<\\
\>                ρ∶Γ⇒RΔ) in\<\\
\>      conv-computeP \{L = nfrep φ ρ\} \{M = nfrep φ' ρ\} step4 (RSTClose.sym step5) step6))\<\\
\>conv-computeE \{A = A ⇛ B\} computeP Γ⊢M∶A Γ⊢N∶A Γ⊢M'∶A Γ⊢N'∶A M≃M' N≃N' Δ ρ∶Γ⇒RΔ Δ⊢Q∶N≡N' computeN computeN' computeQ = \<\\
\>  conv-computeE \{A = B\} \<\\
\>  (computeP Δ ρ∶Γ⇒RΔ Δ⊢Q∶N≡N' computeN computeN' computeQ) \<\\
\>    (appR (weakening Γ⊢M∶A (context-validity Δ⊢Q∶N≡N') ρ∶Γ⇒RΔ) \<\\
\>      (equation-validity₁ Δ⊢Q∶N≡N')) \<\\
\>    (appR (weakening Γ⊢N∶A (context-validity Δ⊢Q∶N≡N') ρ∶Γ⇒RΔ) \<\\
\>      (equation-validity₂ Δ⊢Q∶N≡N'))\<\\
\>    (appR (weakening Γ⊢M'∶A (context-validity Δ⊢Q∶N≡N') ρ∶Γ⇒RΔ) (equation-validity₁ Δ⊢Q∶N≡N')) \<\\
\>    (appR (weakening Γ⊢N'∶A (context-validity Δ⊢Q∶N≡N') ρ∶Γ⇒RΔ) (equation-validity₂ Δ⊢Q∶N≡N')) \<\\
\>    (appT-convl (conv-rep M≃M')) (appT-convl (conv-rep N≃N')) -\}}\<%
\\
\>\AgdaComment{--TODO Common pattern}\<%
\end{code}
}

\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{convE-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M} \AgdaBound{N} \AgdaBound{M'} \AgdaBound{N'} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{P} \AgdaSymbol{:} \AgdaFunction{Path} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaFunction{〉} \AgdaBound{N}\AgdaSymbol{)} \AgdaBound{P} \AgdaSymbol{→} \AgdaBound{M} \AgdaFunction{≃} \AgdaBound{M'} \AgdaSymbol{→} \AgdaBound{N} \AgdaFunction{≃} \AgdaBound{N'} \AgdaSymbol{→} \AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaBound{M'} \AgdaDatatype{∶} \AgdaFunction{ty} \AgdaBound{A} \AgdaSymbol{→} \AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaBound{N'} \AgdaDatatype{∶} \AgdaFunction{ty} \AgdaBound{A} \AgdaSymbol{→} \<[89]%
\>[89]\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{M'} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaFunction{〉} \AgdaBound{N'}\AgdaSymbol{)} \AgdaBound{P}\<%
\end{code}

\AgdaHide{
\begin{code}%
\>\AgdaComment{--convE-E (EI Γ⊢P∶M≡N computeP) M≃M' N≃N' Γ⊢M'∶A Γ⊢N'∶A = EI (convER Γ⊢P∶M≡N Γ⊢M'∶A Γ⊢N'∶A M≃M' N≃N') }\<%
\\
\>\AgdaComment{--  (conv-computeE computeP (equation-validity₁ Γ⊢P∶M≡N) (equation-validity₂ Γ⊢P∶M≡N) Γ⊢M'∶A Γ⊢N'∶A M≃M' N≃N')}\<%
\end{code}
}
\end{enumerate}
\end{proposition}

\AgdaHide{
\begin{code}%
\>\AgdaKeyword{postulate} \AgdaPostulate{⊥-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaInductiveConstructor{Ω}\AgdaSymbol{)} \AgdaFunction{⊥}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{⊃-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ψ}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaInductiveConstructor{Ω}\AgdaSymbol{)} \AgdaBound{φ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaInductiveConstructor{Ω}\AgdaSymbol{)} \AgdaBound{ψ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaInductiveConstructor{Ω}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{⊃} \AgdaBound{ψ}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{appT-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M} \AgdaBound{N} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{B}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{17}{}\<[17]%
\>[17]\AgdaDatatype{valid} \AgdaBound{Γ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaSymbol{(}\AgdaBound{A} \AgdaInductiveConstructor{⇛} \AgdaBound{B}\AgdaSymbol{))} \AgdaBound{M} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{N} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{B}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{appT} \AgdaBound{M} \AgdaBound{N}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{appP-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ} \AgdaBound{ε} \AgdaSymbol{:} \AgdaFunction{Proof} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ψ}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[17]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{⊃} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaBound{δ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaBound{φ} \AgdaBound{ε} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaBound{ψ} \AgdaSymbol{(}\AgdaFunction{appP} \AgdaBound{δ} \AgdaBound{ε}\AgdaSymbol{)}\<%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{plus-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{P} \AgdaSymbol{:} \AgdaFunction{Path} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ} \AgdaBound{ψ} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[17]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{≡〈} \AgdaInductiveConstructor{Ω} \AgdaFunction{〉} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaBound{P} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{⊃} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{plus} \AgdaBound{P}\AgdaSymbol{)}\<%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{minus-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{P} \AgdaSymbol{:} \AgdaFunction{Path} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ} \AgdaBound{ψ} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[18]\AgdaIndent{19}{}\<[19]%
\>[19]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{≡〈} \AgdaInductiveConstructor{Ω} \AgdaFunction{〉} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaBound{P} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{ψ} \AgdaFunction{⊃} \AgdaBound{φ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{minus} \AgdaBound{P}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{funcP-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ} \AgdaSymbol{:} \AgdaFunction{Proof} \AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ψ}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaSymbol{(∀} \AgdaBound{V} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaFunction{Rep} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{ε} \AgdaSymbol{:} \AgdaFunction{Proof} \AgdaBound{V}\AgdaSymbol{)} \AgdaSymbol{→} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{ε} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaBound{ψ} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{appP} \AgdaSymbol{(}\AgdaBound{δ} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{ε}\AgdaSymbol{))} \AgdaSymbol{→} \<[122]%
\>[122]\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaBound{δ} \AgdaDatatype{∶} \AgdaBound{φ} \AgdaFunction{⊃} \AgdaBound{ψ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{⊃} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaBound{δ}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{ref-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A} \AgdaSymbol{:} \AgdaDatatype{Type}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{M} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaFunction{〉} \AgdaBound{M}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{reff} \AgdaBound{M}\AgdaSymbol{)}\<%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{⊃*-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ} \AgdaBound{φ'} \AgdaBound{ψ} \AgdaBound{ψ'} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{P} \AgdaBound{Q} \AgdaSymbol{:} \AgdaFunction{Path} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{≡〈} \AgdaInductiveConstructor{Ω} \AgdaFunction{〉} \AgdaBound{φ'}\AgdaSymbol{)} \AgdaBound{P} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{ψ} \AgdaFunction{≡〈} \AgdaInductiveConstructor{Ω} \AgdaFunction{〉} \AgdaBound{ψ'}\AgdaSymbol{)} \AgdaBound{Q} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{⊃} \AgdaBound{ψ} \AgdaFunction{≡〈} \AgdaInductiveConstructor{Ω} \AgdaFunction{〉} \AgdaBound{φ'} \AgdaFunction{⊃} \AgdaBound{ψ'}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{P} \AgdaFunction{⊃*} \AgdaBound{Q}\AgdaSymbol{)}\<%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{univ-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{φ} \AgdaBound{ψ} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{δ} \AgdaBound{ε} \AgdaSymbol{:} \AgdaFunction{Proof} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{⊃} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaBound{δ} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{ψ} \AgdaFunction{⊃} \AgdaBound{φ}\AgdaSymbol{)} \AgdaBound{ε} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{φ} \AgdaFunction{≡〈} \AgdaInductiveConstructor{Ω} \AgdaFunction{〉} \AgdaBound{ψ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{univ} \AgdaBound{φ} \AgdaBound{ψ} \AgdaBound{δ} \AgdaBound{ε}\AgdaSymbol{)}\<%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{app*-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{N'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{B}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{P}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Q}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaInductiveConstructor{⇛} \AgdaBound{B} \AgdaFunction{〉} \AgdaBound{M'}\AgdaSymbol{)} \AgdaBound{P} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{N} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaFunction{〉} \AgdaBound{N'}\AgdaSymbol{)} \AgdaBound{Q} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{N} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{N'} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{appT} \AgdaBound{M} \AgdaBound{N} \AgdaFunction{≡〈} \AgdaBound{B} \AgdaFunction{〉} \AgdaFunction{appT} \AgdaBound{M'} \AgdaBound{N'}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{app*} \AgdaBound{N} \AgdaBound{N'} \AgdaBound{P} \AgdaBound{Q}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{funcE-E} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{U}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{B}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{M'}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{P}\AgdaSymbol{\}} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaBound{Γ} \AgdaDatatype{⊢} \AgdaBound{P} \AgdaDatatype{∶} \AgdaBound{M} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaInductiveConstructor{⇛} \AgdaBound{B} \AgdaFunction{〉} \AgdaBound{M'} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaSymbol{(∀} \AgdaBound{V} \AgdaSymbol{(}\AgdaBound{Δ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{N} \AgdaBound{N'} \AgdaSymbol{:} \AgdaFunction{Term} \AgdaBound{V}\AgdaSymbol{)} \AgdaBound{Q} \AgdaBound{ρ} \AgdaSymbol{→} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ} \AgdaSymbol{→} \<[74]%
\>[74]\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{N} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{N'} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaBound{N} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaFunction{〉} \AgdaBound{N'}\AgdaSymbol{)} \AgdaBound{Q} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{appT} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{N} \AgdaFunction{≡〈} \AgdaBound{B} \AgdaFunction{〉} \AgdaFunction{appT} \AgdaSymbol{(}\AgdaBound{M'} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{N'}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{app*} \AgdaBound{N} \AgdaBound{N'} \AgdaSymbol{(}\AgdaBound{P} \AgdaFunction{〈} \AgdaBound{ρ} \AgdaFunction{〉}\AgdaSymbol{)} \AgdaBound{Q}\AgdaSymbol{))} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{18}{}\<[18]%
\>[18]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{≡〈} \AgdaBound{A} \AgdaInductiveConstructor{⇛} \AgdaBound{B} \AgdaFunction{〉} \AgdaBound{M'}\AgdaSymbol{)} \AgdaBound{P}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{wteT} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A} \AgdaBound{M} \AgdaBound{B} \AgdaBound{N}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaBound{Γ} \AgdaFunction{,T} \AgdaBound{A} \AgdaDatatype{⊢} \AgdaBound{M} \AgdaDatatype{∶} \AgdaFunction{ty} \AgdaBound{B} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{A}\AgdaSymbol{)} \AgdaBound{N} \AgdaSymbol{→} \AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{B}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{M} \AgdaFunction{⟦} \AgdaFunction{x₀:=} \AgdaBound{N} \AgdaFunction{⟧}\AgdaSymbol{)} \AgdaSymbol{→}\<%
\\
\>[0]\AgdaIndent{17}{}\<[17]%
\>[17]\AgdaRecord{E} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaFunction{ty} \AgdaBound{B}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{appT} \AgdaSymbol{(}\AgdaFunction{ΛT} \AgdaBound{A} \AgdaBound{M}\AgdaSymbol{)} \AgdaBound{N}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaComment{\{-\<\\
\>postulate Neutral-computeE : ∀ \{V\} \{Γ : Context V\} \{M\} \{A\} \{N\} \{P : NeutralP V\} →\<\\
\>                           Γ ⊢ decode P ∶ M ≡〈 A 〉 N → computeE Γ M A N (decode P)\<\\
\>\<\\
\>postulate NF : ∀ \{V\} \{Γ\} \{φ : Term V\} → Γ ⊢ φ ∶ ty Ω → closed-prop\<\\
\>\<\\
\>postulate red-NF : ∀ \{V\} \{Γ\} \{φ : Term V\} (Γ⊢φ∶Ω : Γ ⊢ φ ∶ ty Ω) → φ ↠ cp2term (NF Γ⊢φ∶Ω)\<\\
\>\<\\
\>postulate closed-rep : ∀ \{U\} \{V\} \{ρ : Rep U V\} (A : closed-prop) → (cp2term A) 〈 ρ 〉 ≡ cp2term A\<\\
\>\<\\
\>postulate red-conv : ∀ \{V\} \{C\} \{K\} \{E F : Subexpression V C K\} → E ↠ F → E ≃ F\<\\
\>\<\\
\>postulate confluent : ∀ \{V\} \{φ : Term V\} \{ψ ψ' : closed-prop\} → φ ↠ cp2term ψ → φ ↠ cp2term ψ' → ψ ≡ ψ'\<\\
\>\<\\
\>func-E \{δ = δ\} \{φ = φ\} \{ψ = ψ\} hyp Γ⊢δ∶φ⊃ψ = let Γ⊢φ⊃ψ∶Ω = Prop-Validity Γ⊢δ∶φ⊃ψ in\<\\
\>                      let Γ⊢φ∶Ω = ⊃-gen₁ Γ⊢φ⊃ψ∶Ω in\<\\
\>                      let Γ⊢ψ∶Ω = ⊃-gen₂ Γ⊢φ⊃ψ∶Ω in\<\\
\>                      let φ' = NF Γ⊢φ∶Ω in\<\\
\>                      Γ⊢δ∶φ⊃ψ ,p NF Γ⊢φ∶Ω ⊃C NF Γ⊢ψ∶Ω ,p \<\\
\>                      Prelims.trans-red (respects-red \{f = λ x → x ⊃ ψ\} (λ x → app (appl x)) (red-NF Γ⊢φ∶Ω)) \<\\
\>                                (respects-red \{f = λ x → cp2term (NF Γ⊢φ∶Ω) ⊃ x\} (λ x → app (appr (appl x))) (red-NF Γ⊢ψ∶Ω)) ,p  --TODO Extract lemma for reduction\<\\
\>                      (λ W Δ ρ ε ρ∶Γ⇒Δ Δ⊢ε∶φ computeε →\<\\
\>                      let φρ↠φ' : φ 〈 ρ 〉 ↠ cp2term φ'\<\\
\>                          φρ↠φ' = subst (λ x → (φ 〈 ρ 〉) ↠ x) (closed-rep φ') (respects-red (respects-osr replacement β-respects-rep) (red-NF Γ⊢φ∶Ω)) in\<\\
\>                      let ε∈EΔψ = hyp W Δ ρ ε (context-validity Δ⊢ε∶φ) ρ∶Γ⇒Δ        \<\\
\>                                  ((convR Δ⊢ε∶φ (weakening Γ⊢φ∶Ω (context-validity Δ⊢ε∶φ) ρ∶Γ⇒Δ) (RSTClose.sym (red-conv φρ↠φ')) ) ,p φ' ,p φρ↠φ' ,p computeε ) in \<\\
\>                      let ψ' = proj₁ (proj₂ ε∈EΔψ) in \<\\
\>                      let ψρ↠ψ' : ψ 〈 ρ 〉 ↠ cp2term ψ'\<\\
\>                          ψρ↠ψ' = proj₁ (proj₂ (proj₂ ε∈EΔψ)) in \<\\
\>                      subst (λ a → compute Δ a (appP (δ 〈 ρ 〉) ε)) (confluent ψρ↠ψ' \<\\
\>                        (subst (λ x → (ψ 〈 ρ 〉) ↠ x) (closed-rep (NF Γ⊢ψ∶Ω)) (respects-red (respects-osr replacement β-respects-rep) (red-NF Γ⊢ψ∶Ω)))) \<\\
\>                        (proj₂ (proj₂ (proj₂ ε∈EΔψ))))\<\\
\>\<\\
\>  plus-univ : ∀ \{V\} \{φ ψ : Term V\} \{δ ε\} → key-redex (plus (univ φ ψ δ ε)) δ\<\\
\>  minus-univ : ∀ \{V\} \{φ ψ : Term V\} \{δ ε\} → key-redex (minus (univ φ ψ δ ε)) ε\<\\
\>  imp*-plus : ∀ \{V\} \{P Q : Path V\} \{δ ε\} → key-redex (appP (appP (plus (P ⊃* Q)) δ) ε) (appP (plus Q) (appP δ (appP (minus P) ε)))\<\\
\>  imp*-minus : ∀ \{V\} \{P Q : Path V\} \{δ ε\} → key-redex (appP (appP (minus (P ⊃* Q)) δ) ε) (appP (minus Q) (appP δ (appP (plus P) ε)))\<\\
\>  appPkr : ∀ \{V\} \{δ ε χ : Proof V\} → key-redex δ ε → key-redex (appP δ χ) (appP ε χ)\<\\
\>  pluskr : ∀ \{V\} \{P Q : Path V\} → key-redex P Q → key-redex (plus P) (plus Q)\<\\
\>  minuskr : ∀ \{V\} \{P Q : Path V\} → key-redex P Q → key-redex (minus P) (minus Q)\<\\
\>  app*kr : ∀ \{V\} \{N N' : Term V\} \{P\} \{P'\} \{Q\} → key-redex P P' → key-redex (app* N N' P Q) (app* N N' P' Q)\<\\
\>  plus-ref : ∀ \{V\} \{φ : Term V\} \{δ\} → key-redex (appP (plus (reff φ)) δ) δ\<\\
\>  minus-ref : ∀ \{V\} \{φ : Term V\} \{δ\} → key-redex (appP (minus (reff φ)) δ) δ\<\\
\>  app*-ref : ∀ \{V\} \{M N N' : Term V\} \{Q\} → key-redex (app* N N' (reff M) Q) (M ⋆[ Q ∶ N ∼ N' ])\<\\
\>\<\\
\>postulate key-redex-SN : ∀ \{V\} \{K\} \{E F : Expression V K\} → key-redex E F → SN F → SN E\<\\
\>\<\\
\>postulate key-redex-rep : ∀ \{U\} \{V\} \{K\} \{ρ : Rep U V\} \{E F : Expression U K\} → key-redex E F → key-redex (E 〈 ρ 〉) (F 〈 ρ 〉)\<\\
\>\<\\
\>postulate ref-compute : ∀ \{V\} \{Γ : Context V\} \{M : Term V\} \{A : Type\} → E Γ A M → computeE Γ M A M (reff M)\<\\
\>\<\\
\>postulate Neutral-E : ∀ \{V\} \{Γ : Context V\} \{A\} \{M\} → Neutral M → Γ ⊢ M ∶ ty A → E Γ A M\<\\
\>\<\\
\>var-E : ∀ \{V\} \{A\} (Γ : Context V) (x : Var V -Term) → \<\\
\>  valid Γ → typeof x Γ ≡ ty A → E Γ A (var x)\<\\
\>var-E : ∀ \{V\} (Γ : Context V) (x : Var V -Term) → \<\\
\>        valid Γ → E Γ (typeof' x Γ) (var x)\<\\
\>computeE-SN : ∀ \{V\} \{Γ : Context V\} \{M\} \{N\} \{A\} \{P\} → computeE Γ M A N P → valid Γ → SN P\<\\
\>\<\\
\>computeE-SN \{A = Ω\} \{P\} (P+∈EΓM⊃N ,p \_) \_ = \<\\
\>  let SNplusP : SN (plus P)\<\\
\>      SNplusP = E-SN P+∈EΓM⊃N \<\\
\>  in SNsubbodyl (SNsubexp SNplusP)\<\\
\>computeE-SN \{V\} \{Γ\} \{A = A ⇛ B\} \{P\} computeP validΓ =\<\\
\>  let x₀∈EΓ,AA : E (Γ ,T A) A (var x₀)\<\\
\>      x₀∈EΓ,AA = var-E \{A = A\} (Γ ,T A) x₀ (ctxTR validΓ) refl in\<\\
\>  let SNapp*xxPref : SN (app* (var x₀) (var x₀) (P ⇑) (reff (var x₀)))\<\\
\>      SNapp*xxPref = computeE-SN \{A = B\} (computeP (V , -Term) (Γ ,T A ) upRep \<\\
\>          (var x₀) (var x₀) (app -ref (var x₀ ,, out)) upRep-typed \<\\
\>          (refR (varR x₀ (ctxTR validΓ)) )\<\\
\>          x₀∈EΓ,AA x₀∈EΓ,AA (ref-compute x₀∈EΓ,AA)) \<\\
\>          (ctxTR validΓ)\<\\
\>  in SNap' \{Ops = replacement\} \{σ = upRep\} R-respects-replacement (SNsubbodyl (SNsubbodyr (SNsubbodyr (SNsubexp SNapp*xxPref))))\<\\
\>\<\\
\>\<\\
\>E-SN (Ω) = EΩ.sn\<\\
\>E-SN \{V\} \{Γ\} (A ⇛ B) \{M\} (Γ⊢M∶A⇛B ,p computeM ,p computeMpath) =\<\\
\>  let SNMx : SN (appT (M ⇑) (var x₀))\<\\
\>      SNMx = E-SN B \<\\
\>             (computeM (V , -Term) (Γ ,T A) upRep (var x₀) upRep-typed \<\\
\>             (var-E \{A = A\} (Γ ,T A) x₀ (ctxTR (context-validity Γ⊢M∶A⇛B)) refl)) \<\\
\>  in SNap' \{Ops = replacement\} \{σ = upRep\} R-respects-replacement (SNsubbodyl (SNsubexp SNMx)) \<\\
\>\<\\
\>\{- Neutral-E \{A = Ω\} neutralM Γ⊢M∶A = record \{ \<\\
\>  typed = Γ⊢M∶A ; \<\\
\>  sn = Neutral-SN neutralM \}\<\\
\>Neutral-E \{A = A ⇛ B\} \{M\} neutralM Γ⊢M∶A⇛B = \<\\
\>  Γ⊢M∶A⇛B ,p \<\\
\>  (λ W Δ ρ N ρ∶Γ⇒Δ N∈EΔA → Neutral-E \{A = B\} (app (Neutral-rep M ρ neutralM) (E-SN A N∈EΔA)) \<\\
\>    (appR (weakening Γ⊢M∶A⇛B (context-validity (E-typed N∈EΔA)) ρ∶Γ⇒Δ) (E-typed N∈EΔA))) ,p \<\\
\>  (λ W Δ ρ N N' P ρ∶Γ⇒Δ N∈EΔA N'∈EΔA computeP Δ⊢P∶N≡N' → \<\\
\>    let validΔ = context-validity (E-typed N∈EΔA) in\<\\
\>    Neutral-computeE (Neutral-⋆ (Neutral-rep M ρ neutralM) (computeE-SN computeP validΔ) (E-SN A N∈EΔA) (E-SN A N'∈EΔA)) \<\\
\>    (⋆-typed (weakening Γ⊢M∶A⇛B validΔ ρ∶Γ⇒Δ) Δ⊢P∶N≡N')) -\}\<\\
\>\<\\
\>var-E \{A = A\} Γ x validΓ x∶A∈Γ = Neutral-E (var x) (change-type (varR x validΓ) x∶A∈Γ)\<\\
\>\<\\
\>var-E Γ x validΓ = var-E \{A = typeof' x Γ\} Γ x validΓ typeof-typeof'\<\\
\>\<\\
\>⊥-E validΓ = record \{ typed = ⊥R validΓ ; sn = ⊥SN \}\<\\
\>\<\\
\>⊃-E φ∈EΓΩ ψ∈EΓΩ = record \{ typed = ⊃R (E-typed φ∈EΓΩ) (E-typed ψ∈EΓΩ) ; \<\\
\>  sn = ⊃SN (E-SN Ω φ∈EΓΩ) (E-SN Ω ψ∈EΓΩ) \}\<\\
\>\<\\
\>appT-E \{V\} \{Γ\} \{M\} \{N\} \{A\} \{B\} validΓ (Γ⊢M∶A⇛B ,p computeM ,p computeMpath) N∈EΓA = \<\\
\>  subst (λ a → E Γ B (appT a N)) rep-idOp (computeM V Γ (idRep V) N idRep-typed N∈EΓA)\<\\
\>\<\\
\>postulate cp-typed : ∀ \{V\} \{Γ : Context V\} A → valid Γ → Γ ⊢ cp2term A ∶ ty Ω\<\\
\>\<\\
\>postulate ⊃-not-⊥ : ∀ \{V\} \{φ ψ : Term V\} → φ ⊃ ψ ↠ ⊥ → Empty\<\\
\>\<\\
\>postulate ⊃-inj₁ : ∀ \{V\} \{φ φ' ψ ψ' : Term V\} → φ ⊃ ψ ↠ φ' ⊃ ψ' → φ ↠ φ'\<\\
\>\<\\
\>postulate ⊃-inj₂ : ∀ \{V\} \{φ φ' ψ ψ' : Term V\} → φ ⊃ ψ ↠ φ' ⊃ ψ' → ψ ↠ ψ'\<\\
\>\<\\
\>postulate confluent₂ : ∀ \{V\} \{φ ψ : Term V\} \{χ : closed-prop\} → φ ≃ ψ → φ ↠ cp2term χ → ψ ↠ cp2term χ\<\\
\>\<\\
\>appP-E (\_ ,p ⊥C ,p φ⊃ψ↠⊥ ,p \_) \_ = ⊥-elim (⊃-not-⊥ φ⊃ψ↠⊥)\<\\
\>appP-E \{V\} \{Γ\} \{ε = ε\} \{φ\} \{ψ = ψ\} (Γ⊢δ∶φ⊃ψ ,p (φ' ⊃C ψ') ,p φ⊃ψ↠φ'⊃ψ' ,p computeδ) (Γ⊢ε∶φ ,p φ'' ,p φ↠φ'' ,p computeε) = \<\\
\>  (appPR Γ⊢δ∶φ⊃ψ Γ⊢ε∶φ) ,p ψ' ,p ⊃-inj₂ φ⊃ψ↠φ'⊃ψ' ,p \<\\
\>  subst (λ x → compute Γ ψ' (appP x ε)) rep-idOp \<\\
\>  (computeδ V Γ (idRep V) ε idRep-typed \<\\
\>    (convR Γ⊢ε∶φ (cp-typed φ' (context-validity Γ⊢ε∶φ)) (red-conv (⊃-inj₁ φ⊃ψ↠φ'⊃ψ')))\<\\
\>  (subst (λ x → compute Γ x ε) (confluent φ↠φ'' (⊃-inj₁ φ⊃ψ↠φ'⊃ψ')) computeε))\<\\
\>\<\\
\>conv-E φ≃ψ (Γ⊢δ∶φ ,p φ' ,p φ↠φ' ,p computeδ) Γ⊢ψ∶Ω = convR Γ⊢δ∶φ Γ⊢ψ∶Ω φ≃ψ ,p φ' ,p confluent₂ \{χ = φ'\} φ≃ψ φ↠φ' ,p computeδ\<\\
\>\<\\
\>\<\\
\>postulate rep-E : ∀ \{U\} \{V\} \{Γ\} \{Δ\} \{ρ : Rep U V\} \{φ\} \{δ\} →\<\\
\>                 E Γ φ δ → ρ ∶ Γ ⇒R Δ → E Δ (φ 〈 ρ 〉) (δ 〈 ρ 〉)\<\\
\>\<\\
\>univ-E \{V\} \{Γ\} \{φ\} \{ψ\} \{δ\} \{ε\} δ∈EΓφ⊃ψ ε∈EΓψ⊃φ = \<\\
\>  let Γ⊢univ∶φ≡ψ : Γ ⊢ univ φ ψ δ ε ∶ φ ≡〈 Ω 〉 ψ\<\\
\>      Γ⊢univ∶φ≡ψ = (univR (E-typed δ∈EΓφ⊃ψ) (E-typed ε∈EΓψ⊃φ)) in\<\\
\>      (Γ⊢univ∶φ≡ψ ,p \<\\
\>      expand-E δ∈EΓφ⊃ψ (plusR Γ⊢univ∶φ≡ψ) plus-univ ,p \<\\
\>      expand-E ε∈EΓψ⊃φ (minusR Γ⊢univ∶φ≡ψ) minus-univ)\<\\
\>\<\\
\>postulate rep-E : ∀ \{U\} \{V\} \{Γ\} \{Δ\} \{ρ : Rep U V\} \{E\} \{P\} →\<\\
\>                 E Γ E P → ρ ∶ Γ ⇒R Δ → E Δ (E 〈 ρ 〉) (P 〈 ρ 〉)\<\\
\>\<\\
\>imp*-E \{Γ = Γ\} \{φ\} \{φ'\} \{ψ = ψ\} \{ψ'\} \{P\} \{Q = Q\} P∈EΓφ≡φ' Q∈EΓψ≡ψ' = (⊃*R (E-typed P∈EΓφ≡φ') (E-typed Q∈EΓψ≡ψ')) ,p \<\\
\>  func-E (λ V Δ ρ ε validΔ ρ∶Γ⇒RΔ ε∈EΔφ⊃ψ →\<\\
\>    let Pρ : E Δ (φ 〈 ρ 〉 ≡〈 Ω 〉 φ' 〈 ρ 〉) (P 〈 ρ 〉)\<\\
\>        Pρ = rep-E P∈EΓφ≡φ' ρ∶Γ⇒RΔ in\<\\
\>    let Qρ : E Δ (ψ 〈 ρ 〉 ≡〈 Ω 〉 ψ' 〈 ρ 〉) (Q 〈 ρ 〉)\<\\
\>        Qρ = rep-E Q∈EΓψ≡ψ' ρ∶Γ⇒RΔ in\<\\
\>    func-E (λ W Θ σ χ validΘ σ∶Δ⇒RΘ χ∈EΘφ' → \<\\
\>    let Pρσ : E Θ (φ 〈 ρ 〉 〈 σ 〉 ≡〈 Ω 〉 φ' 〈 ρ 〉 〈 σ 〉) (P 〈 ρ 〉 〈 σ 〉)\<\\
\>        Pρσ = rep-E Pρ σ∶Δ⇒RΘ in\<\\
\>    let Pρσ- : E Θ (φ' 〈 ρ 〉 〈 σ 〉 ⊃ φ 〈 ρ 〉 〈 σ 〉) (minus (P 〈 ρ 〉 〈 σ 〉))\<\\
\>        Pρσ- = minus-E Pρσ in\<\\
\>    let Qρσ : E Θ (ψ 〈 ρ 〉 〈 σ 〉 ≡〈 Ω 〉 ψ' 〈 ρ 〉 〈 σ 〉) (Q 〈 ρ 〉 〈 σ 〉)\<\\
\>        Qρσ = rep-E Qρ σ∶Δ⇒RΘ in\<\\
\>    let Qρσ+ : E Θ (ψ 〈 ρ 〉 〈 σ 〉 ⊃ ψ' 〈 ρ 〉 〈 σ 〉) (plus (Q 〈 ρ 〉 〈 σ 〉))\<\\
\>        Qρσ+ = plus-E Qρσ in\<\\
\>    let εσ : E Θ (φ 〈 ρ 〉 〈 σ 〉 ⊃ ψ 〈 ρ 〉 〈 σ 〉) (ε 〈 σ 〉)\<\\
\>        εσ = rep-E ε∈EΔφ⊃ψ σ∶Δ⇒RΘ in\<\\
\>    expand-E \<\\
\>    (appP-E Qρσ+ (appP-E εσ (appP-E Pρσ- χ∈EΘφ')))\<\\
\>    (appPR (appPR (plusR (⊃*R (E-typed Pρσ) (E-typed Qρσ))) (E-typed εσ)) (E-typed χ∈EΘφ')) \<\\
\>    imp*-plus) \<\\
\>    (appPR (plusR (⊃*R (E-typed Pρ) (E-typed Qρ))) (E-typed ε∈EΔφ⊃ψ))) \<\\
\>  (plusR (⊃*R (E-typed P∈EΓφ≡φ') (E-typed Q∈EΓψ≡ψ'))) ,p \<\\
\>  func-E (λ V Δ ρ ε validΔ ρ∶Γ⇒RΔ ε∈EΔφ'⊃ψ' →\<\\
\>    let Pρ : E Δ (φ 〈 ρ 〉 ≡〈 Ω 〉 φ' 〈 ρ 〉) (P 〈 ρ 〉)\<\\
\>        Pρ = rep-E P∈EΓφ≡φ' ρ∶Γ⇒RΔ in\<\\
\>    let Qρ : E Δ (ψ 〈 ρ 〉 ≡〈 Ω 〉 ψ' 〈 ρ 〉) (Q 〈 ρ 〉)\<\\
\>        Qρ = rep-E Q∈EΓψ≡ψ' ρ∶Γ⇒RΔ in\<\\
\>    func-E (λ W Θ σ χ validΘ σ∶Δ⇒RΘ χ∈EΘφ' → \<\\
\>      let Pρσ : E Θ (φ 〈 ρ 〉 〈 σ 〉 ≡〈 Ω 〉 φ' 〈 ρ 〉 〈 σ 〉) (P 〈 ρ 〉 〈 σ 〉)\<\\
\>          Pρσ = rep-E Pρ σ∶Δ⇒RΘ in\<\\
\>      let Pρσ+ : E Θ (φ 〈 ρ 〉 〈 σ 〉 ⊃ φ' 〈 ρ 〉 〈 σ 〉) (plus (P 〈 ρ 〉 〈 σ 〉))\<\\
\>          Pρσ+ = plus-E Pρσ in\<\\
\>      let Qρσ : E Θ (ψ 〈 ρ 〉 〈 σ 〉 ≡〈 Ω 〉 ψ' 〈 ρ 〉 〈 σ 〉) (Q 〈 ρ 〉 〈 σ 〉)\<\\
\>          Qρσ = rep-E Qρ σ∶Δ⇒RΘ in\<\\
\>      let Qρσ- : E Θ (ψ' 〈 ρ 〉 〈 σ 〉 ⊃ ψ 〈 ρ 〉 〈 σ 〉) (minus (Q 〈 ρ 〉 〈 σ 〉))\<\\
\>          Qρσ- = minus-E Qρσ in\<\\
\>      let εσ : E Θ (φ' 〈 ρ 〉 〈 σ 〉 ⊃ ψ' 〈 ρ 〉 〈 σ 〉) (ε 〈 σ 〉)\<\\
\>          εσ = rep-E ε∈EΔφ'⊃ψ' σ∶Δ⇒RΘ in \<\\
\>      expand-E \<\\
\>        (appP-E Qρσ- (appP-E εσ (appP-E Pρσ+ χ∈EΘφ'))) \<\\
\>          (appPR (appPR (minusR (⊃*R (E-typed Pρσ) (E-typed Qρσ))) (E-typed εσ)) (E-typed χ∈EΘφ')) \<\\
\>        imp*-minus)\<\\
\>    (appPR (minusR (⊃*R (E-typed Pρ) (E-typed Qρ))) (E-typed ε∈EΔφ'⊃ψ'))) \<\\
\>  (minusR (⊃*R (E-typed P∈EΓφ≡φ') (E-typed Q∈EΓψ≡ψ')))\<\\
\>\<\\
\>app*-E \{V\} \{Γ\} \{M\} \{M'\} \{N\} \{N'\} \{A\} \{B\} \{P\} \{Q\} (Γ⊢P∶M≡M' ,p computeP) (Γ⊢Q∶N≡N' ,p computeQ) N∈EΓA N'∈EΓA = (app*R (E-typed N∈EΓA) (E-typed N'∈EΓA) Γ⊢P∶M≡M' Γ⊢Q∶N≡N') ,p \<\\
\>  subst₃\<\\
\>    (λ a b c →\<\\
\>       computeE Γ (appT a N) B (appT b N') (app* N N' c Q))\<\\
\>    rep-idOp rep-idOp rep-idOp \<\\
\>    (computeP V Γ (idRep V) N N' Q idRep-typed Γ⊢Q∶N≡N' \<\\
\>      N∈EΓA N'∈EΓA computeQ)\<\\
\>\<\\
\>func-E \{U\} \{Γ\} \{A\} \{B\} \{M\} \{M'\} \{P\} Γ⊢P∶M≡M' hyp = Γ⊢P∶M≡M' ,p (λ W Δ ρ N N' Q ρ∶Γ⇒Δ Δ⊢Q∶N≡N' N∈EΔA N'∈EΔA computeQ → \<\\
\>  proj₂ (hyp W Δ N N' Q ρ ρ∶Γ⇒Δ N∈EΔA N'∈EΔA (Δ⊢Q∶N≡N' ,p computeQ)))\<\\
\>\<\\
\>ref-E \{V\} \{Γ\} \{M\} \{A\} M∈EΓA = refR (E-typed M∈EΓA) ,p ref-compute M∈EΓA\<\\
\>\<\\
\>expand-E \{V\} \{Γ\} \{A\} \{M\} \{N\} \{P\} \{Q\} (Γ⊢Q∶M≡N ,p computeQ) Γ⊢P∶M≡N P▷Q = Γ⊢P∶M≡N ,p expand-computeE computeQ Γ⊢P∶M≡N P▷Q\<\\
\>\<\\
\>postulate ⊃-respects-conv : ∀ \{V\} \{φ\} \{φ'\} \{ψ\} \{ψ' : Term V\} → φ ≃ φ' → ψ ≃ ψ' →\<\\
\>                          φ ⊃ ψ ≃ φ' ⊃ ψ'\<\\
\>\<\\
\>postulate appT-respects-convl : ∀ \{V\} \{M M' N : Term V\} → M ≃ M' → appT M N ≃ appT M' N\<\\
\>\<\\
\>conv-computeE : ∀ \{V\} \{Γ : Context V\} \{M\} \{M'\} \{N\} \{N'\} \{A\} \{P\} →\<\\
\>             computeE Γ M A N P → M ≃ M' → N ≃ N' → \<\\
\>             Γ ⊢ M' ∶ ty A  → Γ ⊢ N' ∶ ty A  →\<\\
\>             computeE Γ M' A N' P\<\\
\>conv-computeE \{M = M\} \{A = Ω\} \<\\
\>  (EΓM⊃NP+ ,p EΓN⊃MP-) M≃M' N≃N' Γ⊢M'∶Ω Γ⊢N'∶Ω = \<\\
\>  (conv-E (⊃-respects-conv M≃M' N≃N')\<\\
\>    EΓM⊃NP+ (⊃R Γ⊢M'∶Ω Γ⊢N'∶Ω)) ,p \<\\
\>  conv-E (⊃-respects-conv N≃N' M≃M') EΓN⊃MP- (⊃R Γ⊢N'∶Ω Γ⊢M'∶Ω)\<\\
\>conv-computeE \{M = M\} \{M'\} \{N\} \{N'\} \{A = A ⇛ B\} computeP M≃M' N≃N' Γ⊢M'∶A⇛B Γ⊢N'∶A⇛B =\<\\
\>  λ W Δ ρ L L' Q ρ∶Γ⇒RΔ Δ⊢Q∶L≡L' L∈EΔA L'∈EΔA computeQ → conv-computeE \{A = B\} \<\\
\>  (computeP W Δ ρ L L' Q ρ∶Γ⇒RΔ Δ⊢Q∶L≡L' L∈EΔA L'∈EΔA computeQ) \<\\
\>  (appT-respects-convl (respects-conv (respects-osr replacement β-respects-rep) M≃M')) \<\\
\>  (appT-respects-convl (respects-conv (respects-osr replacement β-respects-rep) N≃N')) \<\\
\>  (appR (weakening Γ⊢M'∶A⇛B (context-validity Δ⊢Q∶L≡L') ρ∶Γ⇒RΔ) (E-typed \{W\} \{Γ = Δ\} \{A = A\} \{L\} L∈EΔA)) \<\\
\>  (appR (weakening Γ⊢N'∶A⇛B (context-validity Δ⊢Q∶L≡L') ρ∶Γ⇒RΔ) (E-typed L'∈EΔA)) \<\\
\>--REFACTOR Duplication\<\\
\>\<\\
\>conv-E (Γ⊢P∶M≡N ,p computeP) M≃M' N≃N' Γ⊢M'∶A Γ⊢N'∶A = convER Γ⊢P∶M≡N Γ⊢M'∶A Γ⊢N'∶A M≃M' N≃N' ,p conv-computeE computeP M≃M' N≃N' Γ⊢M'∶A Γ⊢N'∶A\<\\
\>--REFACTOR Duplication                      \<\\
\>                 \<\\
\>E-SN (app (-eq \_) (\_ ,, \_ ,, out)) (Γ⊢P∶E ,p computeP) = computeE-SN computeP (context-validity Γ⊢P∶E) -\}}\<%
\\
%
\\
\>\AgdaKeyword{data} \AgdaDatatype{Emult} \AgdaSymbol{\{}\AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{(}\AgdaBound{Γ} \AgdaSymbol{:} \AgdaDatatype{Context} \AgdaBound{V}\AgdaSymbol{)} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{snocTypes} \AgdaBound{V} \AgdaBound{AA} \AgdaSymbol{→} \AgdaDatatype{snocListExp} \AgdaBound{V} \AgdaBound{AA} \AgdaSymbol{→} \AgdaPrimitiveType{Set} \AgdaKeyword{where}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{[]} \AgdaSymbol{:} \AgdaDatatype{Emult} \AgdaBound{Γ} \AgdaInductiveConstructor{[]} \AgdaInductiveConstructor{[]}\<%
\\
\>[0]\AgdaIndent{2}{}\<[2]%
\>[2]\AgdaInductiveConstructor{\_snoc\_} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{KK} \AgdaBound{K} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{A} \AgdaSymbol{:} \AgdaFunction{Expression} \AgdaSymbol{(}\AgdaFunction{snoc-extend} \AgdaBound{V} \AgdaBound{KK}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{parent} \AgdaBound{K}\AgdaSymbol{)\}} \AgdaSymbol{\{}\AgdaBound{MM} \AgdaBound{M}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Emult} \AgdaBound{Γ} \AgdaSymbol{\{}\AgdaBound{KK}\AgdaSymbol{\}} \AgdaBound{AA} \AgdaBound{MM} \AgdaSymbol{→} \AgdaRecord{E} \AgdaSymbol{\{}\AgdaArgument{K} \AgdaSymbol{=} \AgdaBound{K}\AgdaSymbol{\}} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{A} \AgdaFunction{⟦} \AgdaFunction{xx₀:=} \AgdaBound{MM} \AgdaFunction{⟧}\AgdaSymbol{)} \AgdaBound{M} \AgdaSymbol{→} \AgdaDatatype{Emult} \AgdaBound{Γ} \AgdaSymbol{(}\AgdaBound{AA} \AgdaInductiveConstructor{snoc} \AgdaBound{A}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaBound{MM} \AgdaInductiveConstructor{snoc} \AgdaBound{M}\AgdaSymbol{)}\<%
\\
%
\\
\>\AgdaKeyword{postulate} \AgdaPostulate{Emult-rep} \AgdaSymbol{:} \AgdaSymbol{∀} \AgdaSymbol{\{}\AgdaBound{U} \AgdaBound{V} \AgdaBound{Γ} \AgdaBound{Δ} \AgdaBound{KK} \AgdaBound{AA}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{MM} \AgdaSymbol{:} \AgdaDatatype{snocListExp} \AgdaBound{U} \AgdaBound{KK}\AgdaSymbol{\}} \AgdaSymbol{\{}\AgdaBound{ρ} \AgdaSymbol{:} \AgdaFunction{Rep} \AgdaBound{U} \AgdaBound{V}\AgdaSymbol{\}} \AgdaSymbol{→} \AgdaDatatype{Emult} \AgdaBound{Γ} \AgdaBound{AA} \AgdaBound{MM} \AgdaSymbol{→} \AgdaBound{ρ} \AgdaFunction{∶} \AgdaBound{Γ} \AgdaFunction{⇒R} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaDatatype{valid} \AgdaBound{Δ} \AgdaSymbol{→} \AgdaDatatype{Emult} \AgdaBound{Δ} \AgdaSymbol{(}\AgdaFunction{snocTypes-rep} \AgdaBound{AA} \AgdaBound{ρ}\AgdaSymbol{)} \AgdaSymbol{(}\AgdaFunction{snocListExp-rep} \AgdaBound{MM} \AgdaBound{ρ}\AgdaSymbol{)}\<%
\\
\>\AgdaComment{\{- Emult-rep [] \_ \_ = []\<\\
\>Emult-rep \{U\} \{V\} \{Γ\} \{Δ = Δ\} \{KK snoc K\} \{AA = AA snoc A\} \{MM = MM snoc M\} \{ρ\} (MM∈EΓAA snoc M∈EΓA) ρ∶Γ⇒RΔ validΔ = \<\\
\>  (Emult-rep MM∈EΓAA ρ∶Γ⇒RΔ validΔ) snoc subst (λ x → E Δ x (M 〈 ρ 〉)) (liftsnocRep-botSub \{U\} \{V\} \{KK\} \{E = A\}) (E-rep M∈EΓA ρ∶Γ⇒RΔ validΔ) -\}}\<%
\end{code}
}

